<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Rogue Rich - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent-primary: #38bdf8;
            --accent-secondary: #818cf8;
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --danger: #ef4444;
            --success: #22c55e;
            --gold: #fbbf24;
            --orb: #a855f7;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: #020617;
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .game-wrapper {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        /* ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ */
        .battle-screen {
            flex: 0 0 40%;
            position: relative;
            background: linear-gradient(to bottom, #1e1b4b, #0f172a);
            border-bottom: 2px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
        }

        .stage-info {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-primary);
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
            z-index: 10;
        }

        .units-container {
            height: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 20px;
        }

        .entity {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s;
        }

        .avatar {
            font-size: 3rem;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2));
        }

        .hp-container {
            width: 80px;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hp-fill {
            height: 100%;
            width: 100%;
            transition: width 0.3s ease-out;
        }

        .hp-ally {
            background-color: var(--success);
        }

        .hp-enemy {
            background-color: var(--danger);
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .walking {
            animation: bob 0.6s infinite ease-in-out;
        }

        @keyframes bob {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .hit-flash {
            animation: flash 0.2s;
        }

        @keyframes flash {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(3) contrast(1.5);
            }
        }

        .damage-popup {
            position: absolute;
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            animation: floatUp 0.8s forwards;
            z-index: 100;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }

        /* ç®¡ç†ã‚¨ãƒªã‚¢ */
        .management-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            padding: 15px;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--accent-primary);
            color: var(--bg-color);
            border-color: var(--accent-primary);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* ã‚·ãƒ§ãƒƒãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .shop-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .toggle-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ã‚«ãƒ¼ãƒ‰é¡ */
        .item-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s;
        }

        .item-icon {
            font-size: 2rem;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        .item-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .buy-btn {
            padding: 8px 16px;
            background: var(--accent-secondary);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .buy-btn:disabled {
            background: #475569;
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ */
        .artifact-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 5px;
        }

        .artifact-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            border: 2px solid transparent;
            opacity: 0.3;
            transition: all 0.3s;
            cursor: help;
        }

        .artifact-slot.owned {
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        /* ã‚¬ãƒãƒ£UI */
        .gacha-container {
            padding: 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            border: 1px dashed rgba(168, 85, 247, 0.4);
        }

        .gacha-banner {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #a855f7, #38bdf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gacha-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(to right, #6366f1, #a855f7);
            color: white;
            border: none;
            border-radius: 14px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
            transition: all 0.2s;
        }

        .gacha-btn:active {
            transform: scale(0.96);
        }

        .gacha-owned {
            margin-top: 25px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .gacha-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* çµ±è¨ˆã‚¨ãƒªã‚¢ */
        .footer-stats {
            background: #020617;
            padding: 15px;
            border-radius: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: auto;
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-lbl {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-val {
            font-size: 1rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        .color-gold {
            color: var(--gold);
        }

        .color-orb {
            color: var(--orb);
        }

        .return-btn {
            width: 100%;
            padding: 14px;
            background: #1e293b;
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-top: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .return-btn:hover:not(:disabled) {
            background: #334155;
            border-color: var(--accent-primary);
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .result-card {
            width: 85%;
            max-width: 380px;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            padding: 35px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .tooltip {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid var(--accent-primary);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 0.85rem;
            z-index: 2000;
            pointer-events: none;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .death-flash {
            animation: deathFlash 0.3s ease-out;
        }

        @keyframes deathFlash {
            0% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(10) contrast(2) hue-rotate(90deg);
            }

            100% {
                filter: brightness(1);
            }
        }
    </style>
</head>

<body>

    <div class="game-wrapper">
        <div class="battle-screen">
            <div class="stage-info">STAGE <span id="stage-num">1</span></div>
            <div class="units-container">
                <div class="entity walking" id="ally-entity">
                    <div class="avatar">ğŸ›¡ï¸</div>
                    <div class="hp-container">
                        <div id="ally-hp-bar" class="hp-fill hp-ally"></div>
                    </div>
                </div>
                <div class="entity" id="enemy-entity">
                    <div class="avatar" id="enemy-avatar">ğŸ‘¹</div>
                    <div class="hp-container">
                        <div id="enemy-hp-bar" class="hp-fill hp-enemy"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="management-area">
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('units')">å…µå£«</button>
                <button class="tab-btn" onclick="showTab('artifacts')">å®ç‰©</button>
                <button class="tab-btn" onclick="showTab('gacha')">ã‚¬ãƒãƒ£</button>
            </div>

            <div id="units-tab" class="tab-content active">
                <div class="shop-header">
                    <span class="shop-title">é›‡ç”¨ãƒ»è¨“ç·´</span>
                    <button class="toggle-btn" id="buy-mode-btn" onclick="toggleBuyMode()">è³¼å…¥: x1</button>
                </div>
                <div id="unit-list"></div>
            </div>

            <div id="artifacts-tab" class="tab-content">
                <div class="artifact-grid" id="artifact-list"></div>
            </div>

            <div id="gacha-tab" class="tab-content">
                <div class="gacha-container">
                    <div class="gacha-banner">ğŸŒŒ ç¥åŸŸã®å‘¼ã³å£°</div>
                    <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 25px;">
                        å¤±ã‚ã‚ŒãŸç§˜å®ã‚„å¥‘ç´„ã®ã‚ªãƒ¼ãƒ–ã‚’æ§ã’ã€<br>å†’é™ºã‚’æ’ä¹…çš„ã«å¼·åŒ–ã™ã‚‹ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å¼•ãå½“ã¦ã‚ã€‚
                    </p>
                    <button class="gacha-btn" onclick="pullGacha()">ã‚¬ãƒãƒ£ (100 Orbs)</button>
                    <div id="gacha-owned-list" class="gacha-owned"></div>
                </div>
            </div>

            <div class="footer-stats">
                <div class="stat-box">
                    <span class="stat-lbl">Gold</span>
                    <span id="gold-val" class="stat-val color-gold">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-lbl">Orbs</span>
                    <span id="orb-val" class="stat-val color-orb">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-lbl">DPS</span>
                    <span id="dps-val" class="stat-val">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-lbl">Bonus</span>
                    <span id="multi-val" class="stat-val">x1.0</span>
                </div>
            </div>

            <button class="return-btn" id="return-btn" onclick="handleReturn()">
                å¸°é‚„ã—ã¦ã‚ªãƒ¼ãƒ–ã‚’ç²å¾— (<span id="pending-orbs">0</span>)
            </button>
        </div>

        <div id="result-overlay" class="overlay">
            <div class="result-card">
                <h2 style="color:var(--accent-primary); margin-top:0;">å¸°é‚„é”æˆ</h2>
                <div style="margin: 25px 0; text-align: left; font-size: 1.1rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">åˆ°é”ã‚¹ãƒ†ãƒ¼ã‚¸: <span
                            id="res-stage">1</span></div>
                    <div style="display:flex; justify-content:space-between; color:var(--orb); font-weight:bold;">ç²å¾—ã‚ªãƒ¼ãƒ–:
                        <span id="res-orbs">0</span></div>
                </div>
                <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:15px; margin-bottom:25px;">
                    <div style="font-size:0.8rem; color:var(--text-dim); margin-bottom:10px;">ç²å¾—ã—ãŸå®ç‰©</div>
                    <div id="res-art-list" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;"></div>
                </div>
                <button class="gacha-btn" onclick="closeResult()"
                    style="background:var(--accent-primary); color:var(--bg-color);">æ¬¡å…ƒã‚’è¶Šãˆã‚‹</button>
            </div>
        </div>

        <div id="custom-tooltip" class="tooltip"></div>
    </div>

    <script>
        // --- è¨­å®šãƒ»å®šæ•° ---
        const UNIT_TYPES = [
            { id: 'infantry', name: 'æ­©å…µ', icon: 'ğŸ—¡ï¸', baseAtk: 10, baseCost: 15, unlockAt: 0 },
            { id: 'archer', name: 'å¼“å…µ', icon: 'ğŸ¹', baseAtk: 35, baseCost: 100, unlockAt: 0 },
            { id: 'knight', name: 'é¨å£«', icon: 'ğŸ‡', baseAtk: 120, baseCost: 800, unlockAt: 0 },
            { id: 'samurai', name: 'ä¾', icon: 'ğŸ‘˜', baseAtk: 500, baseCost: 5000, unlockAt: 0 },
            { id: 'warrior', name: 'ãƒ“ãƒƒã‚°ã‚¦ã‚©ãƒ¼ãƒªã‚¢', icon: 'ğŸ›¡ï¸', baseAtk: 2500, baseCost: 50000, unlockAt: 100 },
            { id: 'golem', name: 'ã‚´ãƒ¼ãƒ¬ãƒ ', icon: 'ğŸ—¿', baseAtk: 12000, baseCost: 500000, unlockAt: 200 },
            { id: 'dragon', name: 'ãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼', icon: 'ğŸ‰', baseAtk: 75000, baseCost: 8000000, unlockAt: 300 }
        ];

        const RARITIES = {
            L: { name: 'LEGEND', color: '#fbbf24', chance: 0.005 },
            SR: { name: 'SUPER RARE', color: '#a855f7', chance: 0.025 },
            HR: { name: 'HYPER RARE', color: '#3b82f6', chance: 0.07 },
            R: { name: 'RARE', color: '#22c55e', chance: 0.20 },
            N: { name: 'NORMAL', color: '#94a3b8', chance: 0.70 }
        };

        const ARTIFACT_DATA = [
            { id: 'gungnir', rarity: 'L', name: 'ç¥æ§ã‚°ãƒ³ã‚°ãƒ‹ãƒ«', icon: 'ğŸ”±', effect: 'atk_add', value: 10.0 },
            { id: 'dainsleif', rarity: 'L', name: 'é­”å‰£ãƒ€ã‚¤ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ´', icon: 'ğŸ‘¿', effect: 'atk_add', value: 5.0, special: 'divine_shred' },
            { id: 'death_scythe', rarity: 'L', name: 'æ­»éŒãƒ‡ã‚¹ã‚µã‚¤ã‚º', icon: 'ğŸ’€', effect: 'none', value: 0, special: 'instant_kill' },
            { id: 'legend_sword', rarity: 'SR', name: 'ä¼èª¬ã®å‰£', icon: 'âš”ï¸', effect: 'atk_add', value: 1.0 },
            { id: 'sage_stone', rarity: 'SR', name: 'è³¢è€…ã®çŸ³', icon: 'ğŸ’', effect: 'gold_multi', value: 1.0 },
            { id: 'tyrant_shield', rarity: 'SR', name: 'è¦‡ç‹ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 1.0 },
            { id: 'mithril_sword', rarity: 'HR', name: 'ãƒŸã‚¹ãƒªãƒ«ã®å‰£', icon: 'ğŸ—¡ï¸', effect: 'atk_add', value: 0.75 },
            { id: 'diamond', rarity: 'HR', name: 'ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰', icon: 'ğŸ’ ', effect: 'gold_multi', value: 0.75 },
            { id: 'hero_shield', rarity: 'HR', name: 'å‹‡è€…ã®ç›¾', icon: 'ğŸ”°', effect: 'hp_multi', value: 0.75 },
            { id: 'haste_boots', rarity: 'HR', name: 'éŸ‹é§„å¤©ã®é´', icon: 'ğŸ‘Ÿ', effect: 'atk_multi', value: 0.75 },
            { id: 'crystal', rarity: 'R', name: 'ã‚¯ãƒªã‚¹ã‚¿ãƒ«', icon: 'ğŸ”®', effect: 'gold_multi', value: 0.5 },
            { id: 'iron_shield_r', rarity: 'R', name: 'é‰„ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.5 },
            { id: 'sport_shoes', rarity: 'R', name: 'ã‚¹ãƒãƒ¼ãƒ„ã‚·ãƒ¥ãƒ¼ã‚º', icon: 'ğŸ‘Ÿ', effect: 'atk_multi', value: 0.5 },
            { id: 'gold_sword_r', rarity: 'R', name: 'é»„é‡‘ã®å‰£', icon: 'âœ¨', effect: 'atk_add', value: 0.5 },
            { id: 'iron_sword', rarity: 'N', name: 'é‰„ã®å‰£', icon: 'âš”ï¸', effect: 'atk_add', value: 0.25 },
            { id: 'medal', rarity: 'N', name: 'ãƒ¡ãƒ€ãƒ«', icon: 'ğŸ…', effect: 'gold_multi', value: 0.25 },
            { id: 'shoes', rarity: 'N', name: 'é´', icon: 'ğŸ‘', effect: 'atk_multi', value: 0.25 },
            { id: 'shield_n', rarity: 'N', name: 'ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.25 }
        ];

        const GACHA_ITEMS = [
            { id: 'rainbow_crystal', rarity: 'HR', name: 'è™¹ã®ã‚¯ãƒªã‚¹ã‚¿ãƒ«', icon: 'ğŸŒˆ', desc: '40%ã§å ±é…¬2å€', max: 3, effect: 'double_reward', chance: 0.02 },
            { id: 'universal_contract', rarity: 'SR', name: 'ä¸‡èƒ½ã®å¥‘ç´„æ›¸', icon: 'ğŸ“œ', desc: 'ã‚³ã‚¹ãƒˆ50%æ¸›', max: 1, effect: 'cost_cut', chance: 0.05 },
            { id: 'erined_ring', rarity: 'SR', name: 'ã‚¨ãƒªãƒãƒ‰ã®æŒ‡è¼ª', icon: 'ğŸ’', desc: '30%ã§è¿½åŠ æ”»æ’ƒ(2å€)', max: 1, effect: 'extra_attack', chance: 0.05 },
            { id: 'body_elixir', rarity: 'R', name: 'ä½“ã®ç§˜è–¬', icon: 'ğŸ§ª', desc: 'åˆæœŸæ”»æ’ƒLv+10', max: 3, effect: 'initial_lv', chance: 0.13 },
            { id: 'orichalcum', rarity: 'N', name: 'ã‚ªãƒªãƒãƒ«ã‚³ãƒ³', icon: 'ğŸ§±', desc: 'ã‚³ã‚¤ãƒ³ç²å¾—+1% / å€‹', max: 1000, effect: 'gold_stack', chance: 0.60 },
            { id: 'greed_mask', rarity: 'N', name: 'å¼·æ¬²ã®ä»®é¢', icon: 'ğŸ­', desc: '20%ã§ã‚³ã‚¤ãƒ³3å€', max: 10, effect: 'triple_gold', chance: 0.15 }
        ];

        const ENEMY_ICONS = ['ğŸ‘¹', 'ğŸ’€', 'ğŸ‘»', 'ğŸ§Ÿ', 'ğŸº', 'ğŸ¦‚', 'ğŸ•·ï¸'];

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function formatNumber(num) {
            if (num < 1000) return Math.floor(num).toString();
            const suffixes = ["", "K", "M", "B", "T", "P", "E", "Z"];
            const i = Math.floor(Math.log10(num) / 3);
            const val = num / Math.pow(10, i * 3);
            return (val < 10 ? val.toFixed(2) : val.toFixed(1)) + suffixes[i];
        }

        // --- ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ ---
        class ArtifactManager {
            constructor() { this.owned = {}; }
            draw(count) {
                const results = [];
                for (let i = 0; i < count; i++) {
                    const r = Math.random();
                    let cumulative = 0;
                    let selectedRarity = 'N';
                    for (const [key, meta] of Object.entries(RARITIES)) {
                        cumulative += meta.chance;
                        if (r <= cumulative) { selectedRarity = key; break; }
                    }
                    const pool = ARTIFACT_DATA.filter(a => a.rarity === selectedRarity);
                    const picked = pool[Math.floor(Math.random() * pool.length)];
                    this.owned[picked.id] = (this.owned[picked.id] || 0) + 1;
                    results.push(picked);
                }
                return results;
            }
            getBonuses(stage) {
                let stats = { atkAdd: 0, atkMulti: 1.0, goldMulti: 1.0, hpMulti: 1.0, instantKill: 0 };
                for (const [id, lv] of Object.entries(this.owned)) {
                    const data = ARTIFACT_DATA.find(a => a.id === id);
                    if (!data) continue;
                    let val = data.value * lv;
                    if (data.special === 'divine_shred') val *= (1 + (stage * 0.02));
                    if (data.special === 'instant_kill') stats.instantKill += 0.05; // 5% per level

                    if (data.effect === 'atk_add') stats.atkAdd += val;
                    else if (data.effect === 'atk_multi') stats.atkMulti += val;
                    else if (data.effect === 'gold_multi') stats.goldMulti += val;
                    else if (data.effect === 'hp_multi') stats.hpMulti += val;
                }
                return stats;
            }
        }

        class GachaManager {
            constructor() { this.owned = {}; }
            pull() {
                const r = Math.random();
                let cumulative = 0;
                for (const item of GACHA_ITEMS) {
                    cumulative += item.chance;
                    if (r <= cumulative) {
                        if ((this.owned[item.id] || 0) < item.max) {
                            this.owned[item.id] = (this.owned[item.id] || 0) + 1;
                            return item;
                        }
                    }
                }
                return null;
            }
            getBonuses() {
                let b = { goldStack: 0, tripleGold: 0, doubleReward: 0, costCut: 1.0, extraAttack: 0, initialLv: 0 };
                for (const [id, count] of Object.entries(this.owned)) {
                    const data = GACHA_ITEMS.find(i => i.id === id);
                    if (!data) continue;
                    if (data.effect === 'gold_stack') b.goldStack += count * 0.01;
                    if (data.effect === 'triple_gold') b.tripleGold += count * 0.2;
                    if (data.effect === 'double_reward') b.doubleReward += count * 0.4;
                    if (data.effect === 'cost_cut') b.costCut = 0.5;
                    if (data.effect === 'extra_attack') b.extraAttack = 0.3;
                    if (data.effect === 'initial_lv') b.initialLv += count * 10;
                }
                return b;
            }
        }

        class Game {
            constructor() {
                this.stage = 1; this.gold = 0; this.orbs = 0; this.units = {};
                UNIT_TYPES.forEach(t => this.units[t.id] = 0);
                this.artMgr = new ArtifactManager();
                this.gachaMgr = new GachaManager();
                this.buyMode = 1; // 1, 10, -1(MAX)
            }
            getUnitCost(id, count = 1) {
                const type = UNIT_TYPES.find(u => u.id === id);
                let lv = this.units[id];
                let total = 0;
                const costCut = this.gachaMgr.getBonuses().costCut;
                for (let i = 0; i < count; i++) {
                    total += type.baseCost * Math.pow(1.15, lv + i);
                }
                return Math.floor(total * costCut);
            }
            getMaxBuy(id) {
                const type = UNIT_TYPES.find(u => u.id === id);
                const costCut = this.gachaMgr.getBonuses().costCut;
                let count = 0; let tempGold = this.gold; let lv = this.units[id];
                while (true) {
                    let cost = Math.floor(type.baseCost * Math.pow(1.15, lv + count) * costCut);
                    if (tempGold >= cost && count < 1000) { tempGold -= cost; count++; } else break;
                }
                return count;
            }
            getStats() {
                let baseAtk = 0;
                UNIT_TYPES.forEach(t => baseAtk += t.baseAtk * this.units[t.id]);
                if (baseAtk === 0) baseAtk = 5;

                const a = this.artMgr.getBonuses(this.stage);
                const g = this.gachaMgr.getBonuses();
                const orbBonus = 1 + (this.orbs * 0.1);

                let dps = (baseAtk * (1 + a.atkAdd) * a.atkMulti) * orbBonus;
                return {
                    dps,
                    extraAttack: g.extraAttack,
                    goldMulti: a.goldMulti * (1 + g.goldStack),
                    hpMulti: a.hpMulti,
                    instantKill: a.instantKill,
                    tripleGold: g.tripleGold,
                    doubleReward: g.doubleReward
                };
            }
            save() {
                const data = {
                    s: this.stage, g: this.gold, o: this.orbs, u: this.units,
                    a: this.artMgr.owned, ga: this.gachaMgr.owned
                };
                localStorage.setItem('RPG_SAVE_PRO', JSON.stringify(data));
            }
            load() {
                const raw = localStorage.getItem('RPG_SAVE_PRO');
                if (raw) {
                    const d = JSON.parse(raw);
                    this.stage = d.s || 1; this.gold = d.g || 0; this.orbs = d.o || 0;
                    this.units = d.u || this.units;
                    this.artMgr.owned = d.a || {}; this.gachaMgr.owned = d.ga || {};
                }
            }
        }

        const game = new Game();
        let battle = { enemyHp: 50, enemyMaxHp: 50, allyHp: 200, allyMaxHp: 200, lastTick: Date.now(), isBoss: false };

        // --- UI ---
        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`${t}-tab`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function toggleBuyMode() {
            if (game.buyMode === 1) game.buyMode = 10;
            else if (game.buyMode === 10) game.buyMode = -1;
            else game.buyMode = 1;
            document.getElementById('buy-mode-btn').textContent = `è³¼å…¥: ${game.buyMode === -1 ? 'MAX' : 'x' + game.buyMode}`;
            updateUI();
        }

        function initUI() {
            const list = document.getElementById('unit-list');
            list.innerHTML = '';
            UNIT_TYPES.forEach(type => {
                const card = document.createElement('div');
                card.id = `unit-card-${type.id}`;
                card.className = 'item-card';
                card.style.display = game.stage >= type.unlockAt ? 'flex' : 'none';
                card.innerHTML = `
                    <div class="item-icon">${type.icon}</div>
                    <div class="item-info">
                        <span class="item-name">${type.name} (Lv <span id="lv-${type.id}">0</span>)</span>
                        <span class="item-desc">Atk: ${formatNumber(type.baseAtk)} / Cost: <span id="cost-${type.id}">0</span></span>
                    </div>
                    <button class="buy-btn" id="btn-${type.id}" onclick="buyUnit('${type.id}')">é›‡ç”¨</button>
                `;
                list.appendChild(card);
            });

            const artGrid = document.getElementById('artifact-list');
            artGrid.innerHTML = '';
            ARTIFACT_DATA.forEach(art => {
                const slot = document.createElement('div');
                slot.id = `art-slot-${art.id}`;
                slot.className = 'artifact-slot';
                slot.style.borderColor = RARITIES[art.rarity].color;
                slot.innerHTML = art.icon;
                slot.onmouseenter = (e) => showTooltip(e, art);
                slot.onmouseleave = hideTooltip;
                artGrid.appendChild(slot);
            });
            updateGachaOwned();
        }

        function showTooltip(e, art) {
            const lv = game.artMgr.owned[art.id] || 0;
            const r = RARITIES[art.rarity];
            const tt = document.getElementById('custom-tooltip');
            tt.innerHTML = `
                <div style="color:${r.color}; font-size:0.7rem; font-weight:bold;">${r.name}</div>
                <div style="font-weight:bold; font-size:1rem; margin:4px 0;">${art.name}</div>
                <div style="color:var(--accent-secondary);">Level: ${lv.toLocaleString()}</div>
                <div style="font-size:0.75rem; color:var(--text-dim); margin-top:8px;">
                    åŠ¹æœ: ${art.effect.replace('_', ' ')} (+${(art.value * 100).toFixed(1)}%/Lv)
                    ${art.special ? `<br><span style="color:var(--gold)">â˜…ç‰¹æ®Š: ${art.special}</span>` : ''}
                </div>
            `;
            tt.style.display = 'block';
            moveTooltip(e);
        }

        function moveTooltip(e) {
            const tt = document.getElementById('custom-tooltip');
            tt.style.left = (e.clientX + 15) + 'px';
            tt.style.top = (e.clientY + 15) + 'px';
        }

        function hideTooltip() { document.getElementById('custom-tooltip').style.display = 'none'; }

        function updateGachaOwned() {
            const list = document.getElementById('gacha-owned-list');
            list.innerHTML = '';
            for (const [id, count] of Object.entries(game.gachaMgr.owned)) {
                if (count <= 0) continue;
                const data = GACHA_ITEMS.find(i => i.id === id);
                const el = document.createElement('div');
                el.className = 'gacha-item';
                el.innerHTML = `<span>${data.icon}</span> <span>x${count}</span>`;
                list.appendChild(el);
            }
        }

        function updateUI() {
            const s = game.getStats();
            document.getElementById('stage-num').innerHTML = battle.isBoss ? `<span style="color:var(--danger)">BOSS</span> ${game.stage}` : game.stage;
            document.getElementById('gold-val').textContent = formatNumber(game.gold);
            document.getElementById('orb-val').textContent = game.orbs.toLocaleString();
            document.getElementById('dps-val').textContent = formatNumber(s.dps);

            const baseAtkSum = UNIT_TYPES.reduce((acc, t) => acc + t.baseAtk * game.units[t.id], 0) || 5;
            document.getElementById('multi-val').textContent = `x${(s.dps / baseAtkSum).toFixed(1)}`;

            UNIT_TYPES.forEach(type => {
                const card = document.getElementById(`unit-card-${type.id}`);
                if (game.stage >= type.unlockAt) card.style.display = 'flex';
                let bCount = game.buyMode === -1 ? game.getMaxBuy(type.id) : game.buyMode;
                if (bCount < 1) bCount = 1;
                const cost = game.getUnitCost(type.id, bCount);
                document.getElementById(`lv-${type.id}`).textContent = game.units[type.id].toLocaleString();
                document.getElementById(`cost-${type.id}`).textContent = formatNumber(cost);
                document.getElementById(`btn-${type.id}`).disabled = game.gold < cost;
            });

            ARTIFACT_DATA.forEach(art => {
                const el = document.getElementById(`art-slot-${art.id}`);
                if (game.artMgr.owned[art.id] > 0) el.classList.add('owned');
            });

            const pending = Math.floor(game.stage / 10);
            document.getElementById('pending-orbs').textContent = pending;
            document.getElementById('return-btn').disabled = game.stage < 10;
            document.getElementById('enemy-hp-bar').style.width = (battle.enemyHp / battle.enemyMaxHp * 100) + '%';
            document.getElementById('ally-hp-bar').style.width = (battle.allyHp / battle.allyMaxHp * 100) + '%';
        }

        // --- ãƒ­ã‚¸ãƒƒã‚¯ ---
        function buyUnit(id) {
            let bCount = game.buyMode === -1 ? game.getMaxBuy(id) : game.buyMode;
            if (bCount < 1) return;
            const cost = game.getUnitCost(id, bCount);
            if (game.gold >= cost) {
                game.gold -= cost; game.units[id] += bCount;
                updateUI(); game.save();
            }
        }

        function pullGacha() {
            if (game.orbs >= 100) {
                game.orbs -= 100;
                const res = game.gachaMgr.pull();
                if (res) alert(`ç²å¾—: ${res.icon} ${res.name}\n${res.desc}`);
                else alert(`æ®‹å¿µï¼ä½•ã‚‚ç²å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã¾ãŸã¯æ‰€æŒä¸Šé™ï¼‰ã€‚`);
                updateGachaOwned(); updateUI(); game.save();
            } else alert(`ã‚ªãƒ¼ãƒ–ãŒè¶³ã‚Šã¾ã›ã‚“ï¼`);
        }

        function createPop(val, isGold = false) {
            const screen = document.querySelector('.battle-screen');
            const el = document.createElement('div');
            el.className = 'damage-popup';
            el.textContent = isGold ? `+${formatNumber(val)}G` : `-${formatNumber(val)}`;
            el.style.color = isGold ? 'var(--gold)' : 'var(--danger)';
            el.style.left = `calc(50% + ${(Math.random() * 60 - 30)}px)`;
            el.style.top = `40%`;
            screen.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function spawnEnemy() {
            game.stage++;
            battle.isBoss = (game.stage % 10 === 0);
            let hp = 50 * Math.pow(1.25, game.stage - 1);
            if (battle.isBoss) hp *= 10;
            battle.enemyMaxHp = Math.floor(hp);
            battle.enemyHp = battle.enemyMaxHp;
            document.getElementById('enemy-avatar').textContent = battle.isBoss ? 'ğŸ‰' : ENEMY_ICONS[Math.floor(Math.random() * ENEMY_ICONS.length)];
        }

        function handleReturn() {
            const orbs = Math.floor(game.stage / 10);
            document.getElementById('res-stage').textContent = game.stage;
            document.getElementById('res-orbs').textContent = orbs;

            const arts = game.artMgr.draw(orbs);
            const grid = document.getElementById('res-art-list');
            grid.innerHTML = '';
            arts.slice(0, 12).forEach(a => {
                const d = document.createElement('div');
                d.style.fontSize = '1.2rem'; d.style.border = `1px solid ${RARITIES[a.rarity].color}`;
                d.style.borderRadius = '6px'; d.innerHTML = a.icon; grid.appendChild(d);
            });
            document.getElementById('result-overlay').style.display = 'flex';

            game.orbs += orbs; game.stage = 1; game.gold = 0;
            const g = game.gachaMgr.getBonuses();
            UNIT_TYPES.forEach(t => game.units[t.id] = g.initialLv);
            battle.enemyHp = 50; battle.enemyMaxHp = 50; battle.isBoss = false;
        }

        function closeResult() {
            document.getElementById('result-overlay').style.display = 'none';
            initUI(); updateUI(); game.save();
        }

        function loop() {
            const now = Date.now();
            const dt = (now - battle.lastTick) / 1000;
            battle.lastTick = now;

            const s = game.getStats();
            battle.allyMaxHp = 200 * s.hpMulti;

            // å³æ­»
            if (!battle.isBoss && Math.random() < s.instantKill * dt) {
                battle.enemyHp = 0;
                document.getElementById('enemy-entity').classList.add('death-flash');
                setTimeout(() => document.getElementById('enemy-entity').classList.remove('death-flash'), 400);
            }

            let dps = s.dps;
            if (Math.random() < s.extraAttack) dps *= 2;
            battle.enemyHp -= dps * dt;

            if (now % 600 < 35) { createPop(dps / 2); document.getElementById('enemy-entity').classList.add('hit-flash'); setTimeout(() => document.getElementById('enemy-entity').classList.remove('hit-flash'), 150); }

            if (battle.enemyHp <= 0) {
                let g = 10 * Math.pow(1.2, game.stage - 1) * s.goldMulti;
                if (battle.isBoss) g *= 5;
                if (Math.random() < s.tripleGold) g *= 3;
                if (Math.random() < s.doubleReward) g *= 2;
                game.gold += g;
                createPop(g, true);
                spawnEnemy();
            }

            battle.allyHp -= (2 + game.stage * 1.5) * dt;
            if (battle.allyHp <= 0) {
                game.stage = Math.max(1, game.stage - 1);
                battle.isBoss = (game.stage % 10 === 0);
                battle.enemyMaxHp = Math.floor(50 * Math.pow(1.25, game.stage - 1)) * (battle.isBoss ? 10 : 1);
                battle.enemyHp = battle.enemyMaxHp;
                battle.allyHp = battle.allyMaxHp;
            }

            updateUI();
            requestAnimationFrame(loop);
        }

        game.load();
        initUI();
        updateUI();
        window.addEventListener('mousemove', moveTooltip);
        requestAnimationFrame(loop);
        setInterval(() => game.save(), 5000);
    </script>
</body>

</html>