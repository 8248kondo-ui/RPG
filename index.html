<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Rogue Rich - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent-primary: #38bdf8;
            --accent-secondary: #818cf8;
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --danger: #ef4444;
            --success: #22c55e;
            --gold: #fbbf24;
            --orb: #a855f7;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: #020617;
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            font-size: 16px;
            /* Base font for mobile scaling */
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
        }

        .game-wrapper {
            width: 100%;
            max-width: 500px;
            /* Slightly wider for better UI */
            height: 100vh;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        /* ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ */
        .battle-screen {
            flex: 0 0 35%;
            position: relative;
            background: linear-gradient(to bottom, #1e1b4b, #0f172a);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            transition: box-shadow 0.3s;
        }

        .stage-info {
            position: absolute;
            top: 15px;
            width: 100%;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-primary);
            text-shadow: 0 0 15px rgba(56, 189, 248, 0.6);
            z-index: 10;
        }

        /* è³¼å…¥ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰ */
        .buy-btn:disabled {
            filter: grayscale(100%);
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* å€é€Ÿãƒœã‚¿ãƒ³ */
        .speed-controls {
            position: absolute;
            top: 70px;
            right: 15px;
            display: none;
            /* 50ä½“è¨ä¼ã¾ã§éš ã™ */
            gap: 5px;
            z-index: 100;
        }

        .speed-btn {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--accent-secondary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .speed-btn.active {
            background: var(--accent-secondary);
            font-weight: bold;
        }

        /* ãƒœã‚¹æ¼”å‡ºçœ‹æ¿ */
        .boss-banner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(90deg, transparent, rgba(220, 38, 38, 0.9), transparent);
            color: white;
            width: 100%;
            text-align: center;
            padding: 20px 0;
            font-size: 2rem;
            font-weight: 900;
            z-index: 500;
            pointer-events: none;
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 10px black;
        }

        .boss-banner.show {
            transform: translate(-50%, -50%) scale(1);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ€ã‚¦ãƒ³ï¼šæ§ãˆã‚ãªãƒ’ãƒ“æ¼”å‡º */
        .stage-down-crack {
            position: absolute;
            inset: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M0 0 L20 30 L10 50 L40 70 L30 100 M60 0 L50 40 L80 60 L70 90 L100 100" stroke="white" stroke-width="2" fill="none" opacity="0.5"/></svg>');
            pointer-events: none;
            display: none;
            opacity: 0;
            transition: 0.3s;
        }

        @keyframes shake-lite {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-2px, 2px);
            }

            75% {
                transform: translate(2px, -2px);
            }
        }

        .shake-screen {
            animation: shake-lite 0.2s 3;
        }

        /* å®ç‰©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        .artifact-filter-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .rarity-select {
            background: var(--card-bg);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 5px;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        /* ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .legend-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 2px solid var(--gold);
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            display: none;
            width: 80%;
            max-width: 300px;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
            text-align: center;
        }

        /* èƒŒæ™¯ï¼šéšå±¤è¡¨ç¾ç”¨ */
        #battle-screen {
            transition: background 1s ease;
            background-size: cover;
            background-position: center;
        }

        .bg-plains {
            background: linear-gradient(to bottom, #1e293b, #065f46);
        }

        .bg-ruins {
            background: linear-gradient(to bottom, #1e293b, #4b5563);
        }

        .bg-boss {
            background: linear-gradient(to bottom, #450a0a, #000000) !important;
            animation: red-pulse 4s infinite;
        }

        @keyframes red-pulse {

            0%,
            100% {
                opacity: 0.9;
            }

            50% {
                opacity: 1;
            }
        }

        /* Stage Down ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .stage-down-overlay {
            position: absolute;
            inset: 0;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            pointer-events: none;
            background: radial-gradient(circle, transparent 40%, rgba(239, 68, 68, 0.4) 100%);
        }

        .stage-down-text {
            color: #ff4444;
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 0 20px black;
            animation: warningShake 0.5s infinite;
        }

        @keyframes warningShake {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .edge-flash-red {
            animation: redFlash 0.5s 3;
        }

        @keyframes redFlash {

            0%,
            100% {
                box-shadow: inset 0 0 0px var(--danger);
            }

            50% {
                box-shadow: inset 0 0 40px var(--danger);
            }
        }

        .units-container {
            height: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-top: 30px;
        }

        .entity {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .avatar {
            font-size: 3.5rem;
            filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.3));
        }

        .hp-container {
            width: 100px;
            height: 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hp-fill {
            height: 100%;
            width: 100%;
            transition: width 0.2s ease-out;
        }

        .hp-ally {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .hp-enemy {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        /* ç®¡ç†ã‚¨ãƒªã‚¢ */
        .management-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            padding: 10px;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 5px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: 0.2s;
        }

        .tab-btn.active {
            background: var(--accent-primary);
            color: var(--bg-color);
            border-color: var(--accent-primary);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* ã‚·ãƒ§ãƒƒãƒ—ãƒ»å®Ÿç¸¾ */
        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .shop-title {
            color: var(--accent-primary);
            font-weight: 800;
            font-size: 1.1rem;
        }

        .item-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .item-icon-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .unit-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            font-weight: bold;
        }

        .item-icon {
            font-size: 2.2rem;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            color: var(--text-main);
            font-size: 1rem;
        }

        .item-desc {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .buy-btn {
            padding: 10px 14px;
            background: var(--accent-secondary);
            border-radius: 10px;
            color: white;
            font-weight: 800;
            border: none;
            cursor: pointer;
        }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ¼”å‡º */
        .atk-up-pop {
            position: absolute;
            color: #fbbf24;
            font-weight: 900;
            font-size: 1.4rem;
            pointer-events: none;
            animation: atkPop 0.6s ease-out forwards;
            z-index: 200;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        @keyframes atkPop {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            30% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: translateY(-40px) scale(1);
                opacity: 0;
            }
        }

        /* å®Ÿç¸¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .mission-area {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .mission-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--orb);
            margin-bottom: 5px;
        }

        .mission-item {
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        /* ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ */
        .help-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 100;
            font-weight: bold;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .help-content h3 {
            color: var(--accent-primary);
            border-bottom: 1px solid #334155;
            padding-bottom: 5px;
        }

        .help-content p {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text-dim);
        }

        /* ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè©³ç´°ï¼ˆã‚¬ãƒãƒ£ç”¨ï¼‰ */
        .gacha-item-detail {
            font-size: 0.8rem;
            margin-top: 5px;
            color: var(--accent-secondary);
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šãƒ’ãƒƒãƒˆæ¼”å‡º */
        @keyframes flash {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(3) contrast(1.5);
            }
        }

        .damage-popup {
            position: absolute;
            font-weight: 900;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 0.8s forwards;
            z-index: 100;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 1);
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-60px);
                opacity: 0;
            }
        }

        .footer-stats {
            background: #020617;
            padding: 12px;
            border-radius: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: auto;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-val {
            font-size: 1.1rem;
        }

        /* ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ */
        .artifact-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 5px;
        }

        .artifact-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            border: 2px solid transparent;
            opacity: 0.3;
            transition: all 0.3s;
            cursor: help;
        }

        .artifact-slot.owned {
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        /* ã‚¬ãƒãƒ£UI */
        .gacha-container {
            padding: 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            border: 1px dashed rgba(168, 85, 247, 0.4);
        }

        .gacha-banner {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #a855f7, #38bdf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gacha-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(to right, #6366f1, #a855f7);
            color: white;
            border: none;
            border-radius: 14px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
            transition: all 0.2s;
        }

        .gacha-btn:active {
            transform: scale(0.96);
        }

        .gacha-owned {
            margin-top: 25px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .gacha-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* çµ±è¨ˆã‚¨ãƒªã‚¢ */
        .footer-stats {
            background: #020617;
            padding: 15px;
            border-radius: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: auto;
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-lbl {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-val {
            font-size: 1rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        .color-gold {
            color: var(--gold);
        }

        .color-orb {
            color: var(--orb);
        }

        .return-btn {
            width: 100%;
            padding: 14px;
            background: #1e293b;
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-top: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .return-btn:hover:not(:disabled) {
            background: #334155;
            border-color: var(--accent-primary);
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .result-card {
            width: 85%;
            max-width: 380px;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            padding: 35px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .tooltip {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid var(--accent-primary);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 0.85rem;
            z-index: 2000;
            pointer-events: none;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .death-flash {
            animation: deathFlash 0.3s ease-out;
        }

        @keyframes deathFlash {
            0% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(10) contrast(2) hue-rotate(90deg);
            }

            100% {
                filter: brightness(1);
            }
        }
    </style>
</head>

<body>

    <div class="game-wrapper" id="game-wrapper">
        <div class="help-btn" onclick="openHelp()">?</div>

        <div class="battle-screen" id="battle-screen">
            <div id="stage-down-overlay" class="stage-down-overlay">
                <div class="stage-down-text">âš  Stage Down âš </div>
            </div>
            <div id="stage-down-crack" class="stage-down-crack"></div>
            <div id="boss-banner" class="boss-banner">BOSS STAGE</div>

            <div class="speed-controls" id="speed-controls">
                <button class="speed-btn active" onclick="setSpeed(1)">x1</button>
                <button class="speed-btn" id="speed-x2" onclick="setSpeed(2)">x2</button>
                <button class="speed-btn" id="speed-x3" onclick="setSpeed(3)">x3</button>
            </div>

            <div class="stage-info" id="stage-info-display">STAGE <span id="stage-num">1</span></div>
            <div class="units-container">
                <div class="entity walking" id="ally-entity">
                    <div class="avatar">ğŸ›¡ï¸</div>
                    <div class="hp-container">
                        <div id="ally-hp-bar" class="hp-fill hp-ally"></div>
                    </div>
                </div>
                <div class="entity" id="enemy-entity">
                    <div class="avatar" id="enemy-avatar">ğŸ‘¹</div>
                    <div class="hp-container">
                        <div id="enemy-hp-bar" class="hp-fill hp-enemy"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="management-area">
            <!-- å®Ÿç¸¾ / ãƒŸãƒƒã‚·ãƒ§ãƒ³ -->
            <div class="mission-area">
                <div class="mission-title">ğŸ¯ ãƒ‡ã‚¤ãƒªãƒ¼å®Ÿç¸¾</div>
                <div id="mission-list">
                    <!-- JSã§å‹•çš„ã«è¿½åŠ  -->
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('units')">å…µå£«</button>
                <button class="tab-btn" onclick="showTab('artifacts')">å®ç‰©</button>
                <button class="tab-btn" onclick="showTab('gacha')">ã‚¬ãƒãƒ£</button>
            </div>

            <div id="units-tab" class="tab-content active">
                <div class="shop-header">
                    <span class="shop-title">é›‡ç”¨ãƒ»è¨“ç·´</span>
                    <button class="toggle-btn" id="buy-mode-btn" onclick="toggleBuyMode()">è³¼å…¥: x1</button>
                </div>
                <div id="unit-list"></div>
            </div>

            <div id="artifacts-tab" class="tab-content">
                <div class="artifact-filter-area">
                    <span style="font-size:0.8rem;">ğŸ“¦ å®ç‰©ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</span>
                    <select class="rarity-select" id="rarity-filter" onchange="filterArtifacts()">
                        <option value="ALL">ã™ã¹ã¦</option>
                        <option value="L">LEGEND</option>
                        <option value="SR">SUPER RARE</option>
                        <option value="HR">HYPER RARE</option>
                        <option value="R">RARE</option>
                        <option value="N">NORMAL</option>
                    </select>
                </div>
                <div class="artifact-grid" id="artifact-list">
                    <!-- JSã§å‹•çš„ã«è¿½åŠ  -->
                </div>
            </div>

            <div id="gacha-tab" class="tab-content">
                <div class="gacha-container">
                    <div class="gacha-banner">ğŸŒŒ ç¥åŸŸã®å‘¼ã³å£°</div>
                    <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 25px;">
                        å¤±ã‚ã‚ŒãŸç§˜å®ã‚„å¥‘ç´„ã®ã‚ªãƒ¼ãƒ–ã‚’æ§ã’ã€<br>å†’é™ºã‚’æ’ä¹…çš„ã«å¼·åŒ–ã™ã‚‹ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å¼•ãå½“ã¦ã‚ã€‚
                    </p>
                    <button class="gacha-btn" onclick="pullGacha()">ã‚¬ãƒãƒ£ (100 Orbs)</button>
                    <div id="gacha-owned-list" class="gacha-owned"></div>
                </div>
            </div>

            <div class="footer-stats">
                <div class="stat-box">
                    <span class="stat-lbl">Gold</span>
                    <span id="gold-val" class="stat-val color-gold">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-lbl">Orbs</span>
                    <span id="orb-val" class="stat-val color-orb">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-lbl">DPS</span>
                    <span id="dps-val" class="stat-val">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-lbl">Bonus</span>
                    <span id="multi-val" class="stat-val">x1.0</span>
                </div>
            </div>

            <button class="return-btn" id="return-btn" onclick="handleReturn()">
                å¸°é‚„ã—ã¦ã‚ªãƒ¼ãƒ–ã‚’ç²å¾— (<span id="pending-orbs">0</span>)
            </button>
        </div>

        <!-- ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div id="legend-detail" class="legend-popup" onclick="this.style.display='none'">
            <div id="legend-detail-content"></div>
            <button class="buy-btn" style="margin-top:15px; width:100%;">é–‰ã˜ã‚‹</button>
        </div>

        <div id="result-overlay" class="overlay">
            <div class="result-card">
                <h2 style="color:var(--accent-primary); margin-top:0;">å¸°é‚„é”æˆ</h2>
                <div style="margin: 25px 0; text-align: left; font-size: 1.1rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">åˆ°é”ã‚¹ãƒ†ãƒ¼ã‚¸: <span
                            id="res-stage">1</span></div>
                    <div style="display:flex; justify-content:space-between; color:var(--orb); font-weight:bold;">ç²å¾—ã‚ªãƒ¼ãƒ–:
                        <span id="res-orbs">0</span>
                    </div>
                </div>
                <div style="background:rgba(0,0,0,0.2); border-radius:12px; padding:15px; margin-bottom:25px;">
                    <div style="font-size:0.8rem; color:var(--text-dim); margin-bottom:10px;">ç²å¾—ã—ãŸå®ç‰©</div>
                    <div id="res-art-list" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;"></div>
                </div>
                <button class="gacha-btn" onclick="closeResult()"
                    style="background:var(--accent-primary); color:var(--bg-color);">æ¬¡å…ƒã‚’è¶Šãˆã‚‹</button>
            </div>
        </div>

        <!-- ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="help-modal" class="modal" onclick="closeHelp()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <span class="close-modal" onclick="closeHelp()">&times;</span>
                <div class="help-content">
                    <h3>éŠã³æ–¹</h3>
                    <p><b>1. å…µå£«ã‚’é›‡ãŠã†:</b> ç²å¾—ã—ãŸã‚´ãƒ¼ãƒ«ãƒ‰ã§å…µå£«ã‚’é›‡ç”¨ã—ã€DPSã‚’ä¸Šã’ã¦ãã ã•ã„ã€‚</p>
                    <p><b>2. ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é€²ã‚‚ã†:</b> æ•µã‚’å€’ã™ã¨è‡ªå‹•çš„ã«æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸é€²ã¿ã¾ã™ã€‚10ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«ãƒœã‚¹ãŒå‡ºç¾ã—ã¾ã™ã€‚</p>
                    <p><b>3. å¸°é‚„ã—ã¦å¼·åŒ–:</b> é™ç•Œã‚’æ„Ÿã˜ãŸã‚‰ã€Œå¸°é‚„ã€ã—ã¾ã—ã‚‡ã†ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸æ•°ã«å¿œã˜ãŸã‚ªãƒ¼ãƒ–ã‚’ç²å¾—ã—ã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã§æ°¸ä¹…å¼·åŒ–ã§ãã¾ã™ã€‚</p>
                    <p><b>4. ã‚¬ãƒãƒ£ã§ç§˜å®å…¥æ‰‹:</b> ã‚ªãƒ¼ãƒ–ã‚’ä½¿ã„ã€å¼·åŠ›ãªç‰¹æ®Šèƒ½åŠ›ã‚’æŒã¤ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å¼•ãå½“ã¦ã¾ã—ã‚‡ã†ã€‚</p>
                    <p><b>5. ãƒ¬ã‚¢æ•µå‡ºç¾:</b> ä½ç¢ºç‡ã§å¤§é‡ã®ã‚´ãƒ¼ãƒ«ãƒ‰ã‚’è½ã¨ã™ãƒ¬ã‚¢æ•µãŒå‡ºç¾ã—ã¾ã™ï¼</p>
                </div>
            </div>
        </div>

        <div id="custom-tooltip" class="tooltip"></div>
    </div>

    <script>
        // --- è¨­å®šãƒ»å®šæ•° ---
        const UNIT_TYPES = [
            { id: 'infantry', name: 'æ­©å…µ', icon: 'ğŸ—¡ï¸', baseAtk: 10, baseCost: 15, unlockAt: 0 },
            { id: 'archer', name: 'å¼“å…µ', icon: 'ğŸ¹', baseAtk: 35, baseCost: 100, unlockAt: 0 },
            { id: 'knight', name: 'é¨å£«', icon: 'ğŸ‡', baseAtk: 120, baseCost: 800, unlockAt: 0 },
            { id: 'samurai', name: 'ä¾', icon: 'ğŸ‘˜', baseAtk: 500, baseCost: 5000, unlockAt: 0 },
            { id: 'warrior', name: 'ãƒ“ãƒƒã‚°ã‚¦ã‚©ãƒ¼ãƒªã‚¢', icon: 'ğŸ›¡ï¸', baseAtk: 2500, baseCost: 50000, unlockAt: 100 },
            { id: 'golem', name: 'ã‚´ãƒ¼ãƒ¬ãƒ ', icon: 'ğŸ—¿', baseAtk: 12000, baseCost: 500000, unlockAt: 200 },
            { id: 'dragon', name: 'ãƒ‰ãƒ©ã‚´ãƒ³ãƒ©ã‚¤ãƒ€ãƒ¼', icon: 'ğŸ‰', baseAtk: 75000, baseCost: 8000000, unlockAt: 300 }
        ];

        const RARITIES = {
            L: { name: 'LEGEND', color: '#fbbf24', chance: 0.005 },
            SR: { name: 'SUPER RARE', color: '#a855f7', chance: 0.025 },
            HR: { name: 'HYPER RARE', color: '#3b82f6', chance: 0.07 },
            R: { name: 'RARE', color: '#22c55e', chance: 0.20 },
            N: { name: 'NORMAL', color: '#94a3b8', chance: 0.70 }
        };

        const ARTIFACT_DATA = [
            // --- [æ­¦å™¨ç³»ï¼šå…¨æ”»æ’ƒåŠ›ã‚¢ãƒƒãƒ—] ---
            { id: 'wood_stick', rarity: 'N', name: 'æœ¨ã®æ£’', icon: 'ğŸ¦¯', effect: 'atk_add', value: 0.05 },
            { id: 'bronze_dagger', rarity: 'N', name: 'éŠ…ã®çŸ­å‰£', icon: 'ğŸ”ª', effect: 'atk_add', value: 0.10 },
            { id: 'hunter_bow', rarity: 'N', name: 'ç‹©äººã®å¼“', icon: 'ğŸ¹', effect: 'atk_add', value: 0.15 },
            { id: 'apprentice_staff', rarity: 'N', name: 'è¦‹ç¿’ã„ã®æ–', icon: 'ğŸª„', effect: 'atk_add', value: 0.15 },
            { id: 'stone_axe', rarity: 'N', name: 'çŸ³ã®æ–§', icon: 'ğŸª“', effect: 'atk_add', value: 0.20 },
            { id: 'steel_sword', rarity: 'R', name: 'é‹¼ã®é•·å‰£', icon: 'âš”ï¸', effect: 'atk_add', value: 0.35 },
            { id: 'knight_spear', rarity: 'R', name: 'é¨å£«ã®æ§', icon: 'ğŸ”±', effect: 'atk_add', value: 0.40 },
            { id: 'battle_axe', rarity: 'R', name: 'ãƒãƒˆãƒ«ã‚¢ãƒƒã‚¯ã‚¹', icon: 'ğŸª“', effect: 'atk_add', value: 0.45 },
            { id: 'mage_staff', rarity: 'R', name: 'é­”é“å£«ã®æ–', icon: 'ğŸ”®', effect: 'atk_add', value: 0.45 },
            { id: 'cross_bow', rarity: 'R', name: 'ã‚¯ãƒ­ã‚¹ãƒœã‚¦', icon: 'ğŸ¹', effect: 'atk_add', value: 0.50 },
            { id: 'platinum_sword', rarity: 'HR', name: 'ãƒ—ãƒ©ãƒãƒŠã‚½ãƒ¼ãƒ‰', icon: 'ğŸ—¡ï¸', effect: 'atk_add', value: 0.60 },
            { id: 'guren_staff', rarity: 'HR', name: 'ç´…è“®ã®æ–', icon: 'ğŸ”¥', effect: 'atk_add', value: 0.65 },
            { id: 'berserker_axe', rarity: 'HR', name: 'ç‹‚æˆ¦å£«ã®æ–§', icon: 'ğŸª“', effect: 'atk_add', value: 0.70 },
            { id: 'sniper_bow', rarity: 'HR', name: 'ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼ãƒœã‚¦', icon: 'ğŸ¯', effect: 'atk_add', value: 0.75 },
            { id: 'dragon_spear', rarity: 'HR', name: 'ç«œéª¨ã®æ§', icon: 'ğŸ‰', effect: 'atk_add', value: 0.80 },
            { id: 'oric_sword', rarity: 'SR', name: 'ã‚ªãƒªãƒãƒ«ã‚³ãƒ³ã®å‰£', icon: 'âœ¨', effect: 'atk_add', value: 0.85 },
            { id: 'holy_spear', rarity: 'SR', name: 'è–é¨å£«ã®æ§', icon: 'ğŸ”±', effect: 'atk_add', value: 0.90 },
            { id: 'stardust_staff', rarity: 'SR', name: 'æ˜Ÿå±‘ã®æ–', icon: 'ğŸŒŸ', effect: 'atk_add', value: 0.90 },
            { id: 'giant_axe', rarity: 'SR', name: 'å·¨äººã®æ–§', icon: 'ğŸ”¨', effect: 'atk_add', value: 0.95 },
            { id: 'angel_bow', rarity: 'SR', name: 'å¤©ä½¿ã®å¼“', icon: 'ğŸ‘¼', effect: 'atk_add', value: 1.00 },
            { id: 'excalibur', rarity: 'L', name: 'è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼', icon: 'âš”ï¸', effect: 'atk_add', value: 4.00, special: 'holy_regen' },
            { id: 'muramasa', rarity: 'L', name: 'å¦–åˆ€æ‘æ­£', icon: 'ğŸ”ª', effect: 'atk_add', value: 4.50, special: 'curse_atk' },
            { id: 'sun_staff', rarity: 'L', name: 'å¤ªé™½ã®æ–', icon: 'â˜€ï¸', effect: 'atk_add', value: 3.50, special: 'area_damage' },
            { id: 'destruct_axe', rarity: 'L', name: 'ç ´å£Šã®æ–§', icon: 'ğŸª“', effect: 'atk_add', value: 4.00, special: 'crit_up' },
            { id: 'celestial_bow', rarity: 'L', name: 'å¤©ç©¹ã®å¼“', icon: 'ğŸ¹', effect: 'atk_add', value: 3.50, special: 'pierce_shot' },

            // --- [ç›¾ç³»ï¼šé˜²å¾¡åŠ›ã‚¢ãƒƒãƒ—] ---
            { id: 'wood_buckler', rarity: 'N', name: 'æœ¨ã®ãƒãƒƒã‚¯ãƒ©ãƒ¼', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.10 },
            { id: 'leather_shield', rarity: 'N', name: 'çš®ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.15 },
            { id: 'bronze_shield', rarity: 'N', name: 'éŠ…ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.20 },
            { id: 'pot_lid', rarity: 'N', name: 'ãªã¹ã®ãµãŸ', icon: 'ğŸ³', effect: 'hp_multi', value: 0.05 },
            { id: 'soldier_shield', rarity: 'N', name: 'å…µå£«ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.20 },
            { id: 'steel_shield', rarity: 'R', name: 'é‹¼ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.35 },
            { id: 'silver_shield', rarity: 'R', name: 'éŠ€ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.40 },
            { id: 'knight_shield', rarity: 'R', name: 'é¨å£«ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.45 },
            { id: 'round_shield', rarity: 'R', name: 'ãƒ©ã‚¦ãƒ³ãƒ‰ã‚·ãƒ¼ãƒ«ãƒ‰', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.40 },
            { id: 'kite_shield', rarity: 'R', name: 'ã‚«ã‚¤ãƒˆã‚·ãƒ¼ãƒ«ãƒ‰', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.50 },
            { id: 'plat_shield', rarity: 'HR', name: 'ãƒ—ãƒ©ãƒãƒŠã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.60 },
            { id: 'mithril_shield', rarity: 'HR', name: 'ãƒŸã‚¹ãƒªãƒ«ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.65 },
            { id: 'ice_shield', rarity: 'HR', name: 'æ°·çµã®ç›¾', icon: 'â„ï¸', effect: 'hp_multi', value: 0.70 },
            { id: 'dragon_shield', rarity: 'HR', name: 'ç«œé±—ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.75 },
            { id: 'tower_shield', rarity: 'HR', name: 'ã‚¿ãƒ¯ãƒ¼ã‚·ãƒ¼ãƒ«ãƒ‰', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.80 },
            { id: 'oric_shield', rarity: 'SR', name: 'ã‚ªãƒªãƒãƒ«ã‚³ãƒ³ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.85 },
            { id: 'holy_shield', rarity: 'SR', name: 'è–é¨å£«ã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.90 },
            { id: 'stardust_shield', rarity: 'SR', name: 'æ˜Ÿå±‘ã®ç›¾', icon: 'âœ¨', effect: 'hp_multi', value: 0.95 },
            { id: 'giant_shield', rarity: 'SR', name: 'å·¨äººã®ç›¾', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 0.95 },
            { id: 'spirit_shield', rarity: 'SR', name: 'ç²¾éœŠã®ç›¾', icon: 'ğŸƒ', effect: 'hp_multi', value: 1.00 },
            { id: 'aegis', rarity: 'L', name: 'ç¥ç›¾ã‚¤ãƒ¼ã‚¸ã‚¹', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 4.00, special: 'cheat_death' },
            { id: 'prydwen', rarity: 'L', name: 'è–ç›¾ãƒ—ãƒªãƒˆã‚¦ã‚§ãƒ³', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 3.50, special: 'reflect_dmg' },
            { id: 'genbu_shell', rarity: 'L', name: 'ç„æ­¦ã®ç”²ç¾…', icon: 'ğŸ¢', effect: 'hp_multi', value: 5.00, special: 'slow_move' },
            { id: 'argos', rarity: 'L', name: 'é­”ç›¾ã‚¢ãƒ«ã‚´ã‚¹', icon: 'ğŸ›¡ï¸', effect: 'hp_multi', value: 4.50, special: 'resist_all' },
            { id: 'void_shield', rarity: 'L', name: 'è™šç„¡ã®ç›¾', icon: 'ğŸŒ€', effect: 'hp_multi', value: 4.00, special: 'absorb_atk' },

            // --- [ã‚³ã‚¤ãƒ³ç³»ï¼šãŠé‡‘ç²å¾—ç‡ã‚¢ãƒƒãƒ—] ---
            { id: 'copper_coin', rarity: 'N', name: 'éŠ…è²¨', icon: 'ğŸª™', effect: 'gold_multi', value: 0.10 },
            { id: 'old_wallet', rarity: 'N', name: 'å¤ã³ãŸè²¡å¸ƒ', icon: 'ğŸ‘›', effect: 'gold_multi', value: 0.15 },
            { id: 'small_gem', rarity: 'N', name: 'å°ã•ãªå®çŸ³', icon: 'ğŸ’', effect: 'gold_multi', value: 0.15 },
            { id: 'silver_ring', rarity: 'N', name: 'éŠ€ã®æŒ‡è¼ª', icon: 'ğŸ’', effect: 'gold_multi', value: 0.20 },
            { id: 'piggy_bank', rarity: 'N', name: 'è²¯é‡‘ç®±', icon: 'ğŸ·', effect: 'gold_multi', value: 0.25 },
            { id: 'silver_coin', rarity: 'R', name: 'éŠ€è²¨', icon: 'ğŸª™', effect: 'gold_multi', value: 0.35 },
            { id: 'gold_coin', rarity: 'R', name: 'é‡‘è²¨', icon: 'ğŸª™', effect: 'gold_multi', value: 0.40 },
            { id: 'gold_bar', rarity: 'R', name: 'é‡‘ã®å»¶ã¹æ£’', icon: 'ğŸ§±', effect: 'gold_multi', value: 0.45 },
            { id: 'merchant_wallet', rarity: 'R', name: 'å•†äººã®è²¡å¸ƒ', icon: 'ğŸ’°', effect: 'gold_multi', value: 0.50 },
            { id: 'pearl_necklace', rarity: 'R', name: 'çœŸç ã®ãƒãƒƒã‚¯ãƒ¬ã‚¹', icon: 'ğŸ“¿', effect: 'gold_multi', value: 0.50 },
            { id: 'treasure_map', rarity: 'HR', name: 'å®ã®åœ°å›³', icon: 'ğŸ—ºï¸', effect: 'gold_multi', value: 0.60 },
            { id: 'golden_cup', rarity: 'HR', name: 'é»„é‡‘ã®æ¯', icon: 'ğŸ†', effect: 'gold_multi', value: 0.65 },
            { id: 'kings_crown', rarity: 'HR', name: 'ç‹ã®å† ', icon: 'ğŸ‘‘', effect: 'gold_multi', value: 0.70 },
            { id: 'platinum_ring', rarity: 'HR', name: 'ãƒ—ãƒ©ãƒãƒŠãƒªãƒ³ã‚°', icon: 'ğŸ’', effect: 'gold_multi', value: 0.75 },
            { id: 'ruby_eyes', rarity: 'HR', name: 'ãƒ«ãƒ“ãƒ¼ã®ç³', icon: 'ğŸ‘ï¸', effect: 'gold_multi', value: 0.75 },
            { id: 'infinite_ring', rarity: 'SR', name: 'å·¨å¯Œã®æŒ‡è¼ª', icon: 'ğŸ’', effect: 'gold_multi', value: 0.85 },
            { id: 'eldorado_key', rarity: 'SR', name: 'é»„é‡‘éƒ·ã®éµ', icon: 'ğŸ”‘', effect: 'gold_multi', value: 0.90 },
            { id: 'alchemy_book', rarity: 'SR', name: 'éŒ¬é‡‘è¡“ã®æ›¸', icon: 'ğŸ“–', effect: 'gold_multi', value: 0.95 },
            { id: 'treasure_chest', rarity: 'SR', name: 'è²¡å®ã®ç®±', icon: 'ğŸ', effect: 'gold_multi', value: 1.00 },
            { id: 'sun_stone', rarity: 'SR', name: 'å¤ªé™½ã®çŸ³', icon: 'â˜€ï¸', effect: 'gold_multi', value: 1.00 },
            { id: 'horn_plenty', rarity: 'L', name: 'è±Šç©£ã®è§’', icon: 'ğŸš', effect: 'gold_multi', value: 3.00, special: 'lucky_drop' },
            { id: 'midas_hand', rarity: 'L', name: 'ãƒŸãƒ€ã‚¹ç‹ã®æ‰‹', icon: 'âœ‹', effect: 'gold_multi', value: 4.00, special: 'extra_coin' },
            { id: 'magic_hammer', rarity: 'L', name: 'æ‰“ã¡å‡ºã®å°æ§Œ', icon: 'ğŸ”¨', effect: 'gold_multi', value: 3.50, special: 'pain_coin' },
            { id: 'mammon_coin', rarity: 'L', name: 'ãƒãƒ¢ãƒ³ã®é‡‘è²¨', icon: 'ğŸª™', effect: 'gold_multi', value: 5.00, special: 'greed_aura' },
            { id: 'dragon_scale_gold', rarity: 'L', name: 'é»„é‡‘ç«œã®é€†é±—', icon: 'ğŸ‰', effect: 'gold_multi', value: 4.50, special: 'boss_rich' },

            // --- [ã‚¹ãƒ”ãƒ¼ãƒ‰ç³»ï¼šæ”»æ’ƒé€Ÿåº¦ã‚¢ãƒƒãƒ—] ---
            { id: 'light_gloves', rarity: 'N', name: 'è»½ã„æ‰‹è¢‹', icon: 'ğŸ§¤', effect: 'atk_multi', value: 0.10 },
            { id: 'wind_feather', rarity: 'N', name: 'é¢¨ã®ç¾½é£¾ã‚Š', icon: 'ğŸª¶', effect: 'atk_multi', value: 0.15 },
            { id: 'old_clock', rarity: 'N', name: 'å¤ã„æ™‚è¨ˆ', icon: 'â°', effect: 'atk_multi', value: 0.15 },
            { id: 'flexible_whip', rarity: 'N', name: 'ã—ãªã‚„ã‹ãªé­', icon: 'ğŸ¦¯', effect: 'atk_multi', value: 0.20 },
            { id: 'agility_ring', rarity: 'N', name: 'ä¿Šæ•ã®ãƒªãƒ³ã‚°', icon: 'ğŸ’', effect: 'atk_multi', value: 0.25 },
            { id: 'thief_bandana', rarity: 'R', name: 'ç›—è³Šã®ãƒãƒ³ãƒ€ãƒŠ', icon: 'ğŸ§£', effect: 'atk_multi', value: 0.35 },
            { id: 'ninja_band', rarity: 'R', name: 'å¿è€…ã®é‰¢å·»ã', icon: 'ğŸ¥‹', effect: 'atk_multi', value: 0.40 },
            { id: 'wind_talisman', rarity: 'R', name: 'é¢¨ã®è­·ç¬¦', icon: 'ğŸ§¿', effect: 'atk_multi', value: 0.45 },
            { id: 'speed_ring', rarity: 'R', name: 'ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒªãƒ³ã‚°', icon: 'ğŸ’', effect: 'atk_multi', value: 0.50 },
            { id: 'acrobat_cloak', rarity: 'R', name: 'è»½æ¥­å¸«ã®å¤–å¥—', icon: 'ğŸ§¥', effect: 'atk_multi', value: 0.50 },
            { id: 'gale_boots', rarity: 'HR', name: 'ç–¾é¢¨ã®ãƒ–ãƒ¼ãƒ„', icon: 'ğŸ¥¾', effect: 'atk_multi', value: 0.60 },
            { id: 'lightning_ring', rarity: 'HR', name: 'é›·å…‰ã®æŒ‡è¼ª', icon: 'âš¡', effect: 'atk_multi', value: 0.65 },
            { id: 'phantom_cloak', rarity: 'HR', name: 'å¹»å½±ã®å¤–å¥—', icon: 'ğŸ§¥', effect: 'atk_multi', value: 0.70 },
            { id: 'fairy_wing', rarity: 'HR', name: 'å¦–ç²¾ã®ç¾½', icon: 'ğŸ§š', effect: 'atk_multi', value: 0.75 },
            { id: 'sand_clock', rarity: 'HR', name: 'æ™‚ã®ç ‚æ™‚è¨ˆ', icon: 'â³', effect: 'atk_multi', value: 0.75 },
            { id: 'sonic_shoes', rarity: 'SR', name: 'éŸ³é€Ÿã®é´', icon: 'ğŸ‘Ÿ', effect: 'atk_multi', value: 0.85 },
            { id: 'god_speed_ring', rarity: 'SR', name: 'ç¥é€Ÿã®æŒ‡è¼ª', icon: 'ğŸ’', effect: 'atk_multi', value: 0.90 },
            { id: 'swallow_robe', rarity: 'SR', name: 'é£›ç‡•ã®ç¾½è¡£', icon: 'ğŸ‘˜', effect: 'atk_multi', value: 0.95 },
            { id: 'time_leap', rarity: 'SR', name: 'æ™‚é–“è·³èºã®æ™‚è¨ˆ', icon: 'ğŸ•°ï¸', effect: 'atk_multi', value: 1.00 },
            { id: 'star_talisman', rarity: 'SR', name: 'æ˜Ÿæµã®è­·ç¬¦', icon: 'ğŸ’«', effect: 'atk_multi', value: 1.00 },
            { id: 'pegasus_boots', rarity: 'L', name: 'å¤©é¦¬ã®é´', icon: 'ğŸ‘¢', effect: 'atk_multi', value: 3.00, special: 'evasion_up' },
            { id: 'raijin_drum', rarity: 'L', name: 'é›·ç¥ã®å¤ªé¼“', icon: 'ğŸ¥', effect: 'atk_multi', value: 4.00, special: 'double_tap' },
            { id: 'chronos_clock', rarity: 'L', name: 'ã‚¯ãƒ­ãƒã‚¹ã®æ™‚è¨ˆ', icon: 'ğŸ•™', effect: 'atk_multi', value: 3.50, special: 'time_stop' },
            { id: 'fuujin_bag', rarity: 'L', name: 'é¢¨ç¥ã®è¢‹', icon: 'ğŸ¥¡', effect: 'atk_multi', value: 5.00, special: 'no_delay' },
            { id: 'light_wing', rarity: 'L', name: 'å…‰é€Ÿã®ç¿¼', icon: 'ğŸ‘¼', effect: 'atk_multi', value: 4.50, special: 'instant_action' },

            // --- æ—¢å­˜ã®ç‰¹æ®Šç¥å™¨ (äº’æ›æ€§ã®ãŸã‚ç¶­æŒ) ---
            { id: 'gungnir', rarity: 'L', name: 'ç¥æ§ã‚°ãƒ³ã‚°ãƒ‹ãƒ«', icon: 'ğŸ”±', effect: 'atk_add', value: 10.0 },
            { id: 'dainsleif', rarity: 'L', name: 'é­”å‰£ãƒ€ã‚¤ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ´', icon: 'ğŸ‘¿', effect: 'atk_add', value: 5.0, special: 'divine_shred' },
            { id: 'death_scythe', rarity: 'L', name: 'æ­»éŒãƒ‡ã‚¹ã‚µã‚¤ã‚º', icon: 'ğŸ’€', effect: 'none', value: 0, special: 'instant_kill' },
        ];

        const GACHA_ITEMS = [
            // --- ã‚«ãƒ†ã‚´ãƒª1: æˆ¦é—˜ãƒ»å…µç¨®å¼·åŒ– (20ç¨®) ---
            { id: 'dragon_scale', rarity: 'R', name: 'ç«œã®é±—', icon: 'ğŸ›¡ï¸', desc: 'é˜²å¾¡HP +5% / å€‹', max: 50, effect: 'hp_stack', chance: 0.10 },
            { id: 'exe_axe', rarity: 'SR', name: 'å‡¦åˆ‘äººã®æ–§', icon: 'ğŸª“', desc: 'ãƒœã‚¹ç‰¹æ”» +10% / å€‹', max: 10, effect: 'boss_slayer', chance: 0.05 },
            { id: 'sharp_whetstone', rarity: 'N', name: 'é‹­ã„ç ¥çŸ³', icon: 'ğŸª¨', desc: 'å…¨å…µç¨®æ”»æ’ƒåŠ› +2% / å€‹', max: 100, effect: 'atk_stack', chance: 0.20 },
            { id: 'crit_gem', rarity: 'HR', name: 'ä¼šå¿ƒã®é­”çŸ³', icon: 'âœ¨', desc: 'ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡ +1% / å€‹', max: 50, effect: 'crit_stack', chance: 0.08 },
            { id: 'vampire_fury', rarity: 'SR', name: 'å¸è¡€é¬¼ã®æ€’ã‚Š', icon: 'ğŸ§›', desc: 'HPå†ç”Ÿ +0.5% / å€‹', max: 20, effect: 'regen_stack', chance: 0.04 },
            { id: 'shield_spikes', rarity: 'R', name: 'ç›¾ã®ã‚¹ãƒ‘ã‚¤ã‚¯', icon: 'ğŸ›¡ï¸', desc: 'ãƒ€ãƒ¡ãƒ¼ã‚¸åå°„ +5% / å€‹', max: 20, effect: 'reflect_stack', chance: 0.07 },
            { id: 'phantom_boots', rarity: 'HR', name: 'å¹»å½±ã®ãƒ–ãƒ¼ãƒ„', icon: 'ğŸ¥¾', desc: 'å›é¿ç‡ +1% / å€‹', max: 30, effect: 'evade_stack', chance: 0.06 },
            { id: 'infinite_quiver', rarity: 'R', name: 'ç„¡é™ã®çŸ¢ç­’', icon: 'ğŸ¹', desc: 'é€£ç¶šæ”»æ’ƒç‡ +2% / å€‹', max: 25, effect: 'double_stack', chance: 0.10 },
            { id: 'holy_pendant', rarity: 'SR', name: 'è–ãªã‚‹ãƒšãƒ³ãƒ€ãƒ³ãƒˆ', icon: 'ğŸ“¿', desc: 'å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ +3% / å€‹', max: 15, effect: 'all_stats', chance: 0.03 },
            { id: 'war_horn', rarity: 'N', name: 'æˆ¦ã„ã®è§’ç¬›', icon: 'ğŸ“¯', desc: 'å…µæ•°æ”»æ’ƒåŠ› +1% / å€‹', max: 200, effect: 'atk_stack_lite', chance: 0.25 },
            { id: 'soul_eater', rarity: 'L', name: 'ã‚½ã‚¦ãƒ«ã‚¤ãƒ¼ã‚¿ãƒ¼', icon: 'ğŸ’€', desc: 'å³æ­»ç‡ +0.5% / å€‹', max: 10, effect: 'inst_stack', chance: 0.01 },
            { id: 'fire_brand', rarity: 'HR', name: 'ç„¦ç†±ã®å°', icon: 'ğŸ”¥', desc: 'å±æ€§æ”»æ’ƒåŠ› +5% / å€‹', max: 30, effect: 'atk_stack', chance: 0.06 },
            { id: 'clovers_luck', rarity: 'N', name: 'å››è‘‰ã®ã‚¯ãƒ­ãƒ¼ãƒãƒ¼', icon: 'ğŸ€', desc: 'å‘½ä¸­ç‡ãƒ»å›é¿ç‡ +0.5% / å€‹', max: 50, effect: 'luck_stack', chance: 0.15 },
            { id: 'titan_blood', rarity: 'SR', name: 'å·¨äººã®è¡€', icon: 'ğŸ·', desc: 'æœ€å¤§HP +15% / å€‹', max: 10, effect: 'hp_stack_heavy', chance: 0.04 },
            { id: 'berserk_mask', rarity: 'HR', name: 'ç‹‚æˆ¦å£«ã®ä»®é¢', icon: 'ğŸ‘º', desc: 'æ”»æ’ƒç‰¹åŒ– +8% / å€‹', max: 20, effect: 'atk_stack', chance: 0.05 },
            { id: 'mirror_armor', rarity: 'SR', name: 'é¡ã®é§', icon: 'ğŸ¥‹', desc: 'é­”æ³•åå°„ +10% / å€‹', max: 10, effect: 'reflect_stack', chance: 0.03 },
            { id: 'wind_step', rarity: 'R', name: 'ç–¾é¢¨ã®æ­©æ³•', icon: 'ğŸ‘Ÿ', desc: 'é€Ÿã•è£œæ­£ +3% / å€‹', max: 30, effect: 'speed_stack', chance: 0.08 },
            { id: 'iron_wall', rarity: 'N', name: 'é‰„å£ã®èª“ã„', icon: 'ğŸ§±', desc: 'HP +2% / å€‹', max: 100, effect: 'hp_stack_lite', chance: 0.18 },
            { id: 'hero_scarf', rarity: 'HR', name: 'å‹‡è€…ã®ã‚¹ã‚«ãƒ¼ãƒ•', icon: 'ğŸ§£', desc: 'DPS +4% / å€‹', max: 40, effect: 'atk_stack', chance: 0.07 },
            { id: 'blessed_water', rarity: 'SR', name: 'è–æ°´', icon: 'ğŸ¶', desc: 'ãƒ‡ãƒãƒ•è€æ€§ +10% / å€‹', max: 5, effect: 'none', chance: 0.02 },

            // --- ã‚«ãƒ†ã‚´ãƒª2: çµŒæ¸ˆãƒ»æ”¾ç½®åŠ¹ç‡ (15ç¨®) ---
            { id: 'merch_scale', rarity: 'R', name: 'å•†äººã®å¤©ç§¤', icon: 'âš–ï¸', desc: 'ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬ +5% / å€‹', max: 40, effect: 'gold_stack', chance: 0.12 },
            { id: 'cheat_ledger', rarity: 'SR', name: 'å€¤åˆ‡ã‚Šã®è£å¸³ç°¿', icon: 'ğŸ“’', desc: 'ã‚³ã‚¹ãƒˆå‰Šæ¸› +2% / å€‹', max: 20, effect: 'cost_stack', chance: 0.05 },
            { id: 'golden_touch', rarity: 'HR', name: 'é»„é‡‘ã®æŒ‡å…ˆ', icon: 'âœ¨', desc: 'ã‚¿ãƒƒãƒ—ã‚´ãƒ¼ãƒ«ãƒ‰ +20% / å€‹', max: 50, effect: 'gold_stack', chance: 0.08 },
            { id: 'bank_note', rarity: 'N', name: 'éŠ€è¡Œã®ä¸æ›ç´™å¹£', icon: 'ğŸ’µ', desc: 'ã‚´ãƒ¼ãƒ«ãƒ‰ç²å¾— +1% / å€‹', max: 250, effect: 'gold_stack_lite', chance: 0.22 },
            { id: 'lucky_cat', rarity: 'R', name: 'æ‹›ãçŒ«', icon: 'ğŸ±', desc: 'ãƒ¬ã‚¢æ•µå‡ºç¾ç‡ +10% / å€‹', max: 10, effect: 'rare_spawn', chance: 0.10 },
            { id: 'greed_coin', rarity: 'HR', name: 'å¼·æ¬²ã®ã‚³ã‚¤ãƒ³', icon: 'ğŸª™', desc: 'ã‚´ãƒ¼ãƒ«ãƒ‰å€ç‡ +10% / å€‹', max: 30, effect: 'gold_stack', chance: 0.07 },
            { id: 'tax_exempt', rarity: 'SR', name: 'å…ç¨è¨±å¯è¨¼', icon: 'ğŸ“œ', desc: 'ã‚´ãƒ¼ãƒ«ãƒ‰ç²å¾— +15% / å€‹', max: 15, effect: 'gold_stack', chance: 0.04 },
            { id: 'bag_of_holding', rarity: 'N', name: 'å››æ¬¡å…ƒã®è¢‹', icon: 'ğŸ¥¡', desc: 'ã‚´ãƒ¼ãƒ«ãƒ‰ç²å¾— +0.5% / å€‹', max: 500, effect: 'gold_stack_tiny', chance: 0.30 },
            { id: 'midas_scroll', rarity: 'SR', name: 'ãƒŸãƒ€ã‚¹ã®å¤æ–‡æ›¸', icon: 'ğŸ“œ', desc: 'å…¨åå…¥ +5% / å€‹', max: 20, effect: 'gold_stack', chance: 0.03 },
            { id: 'pension_fund', rarity: 'HR', name: 'å¹´é‡‘ã®æ¨©åˆ©', icon: 'ğŸ¦', desc: 'æ”¾ç½®åå…¥ +10% / å€‹', max: 50, effect: 'gold_stack', chance: 0.06 },
            { id: 'scout_goggles', rarity: 'R', name: 'ã‚¹ã‚«ã‚¦ã‚¿ãƒ¼', icon: 'ğŸ¥½', desc: 'è¨ä¼ã‚´ãƒ¼ãƒ«ãƒ‰ +4% / å€‹', max: 50, effect: 'gold_stack', chance: 0.11 },
            { id: 'diamond_pick', rarity: 'SR', name: 'ãƒ€ã‚¤ãƒ¤ã®ã¤ã‚‹ã¯ã—', icon: 'â›ï¸', desc: 'é‰±å±±åå…¥ +50%', max: 1, effect: 'gold_stack', chance: 0.01 },
            { id: 'crystal_ball', rarity: 'HR', name: 'äºˆæ„Ÿã®æ°´æ™¶', icon: 'ğŸ”®', desc: 'ã‚´ãƒ¼ãƒ«ãƒ‰ç²å¾— +6% / å€‹', max: 30, effect: 'gold_stack', chance: 0.07 },
            { id: 'monopoly_card', rarity: 'SR', name: 'ç‹¬å ã‚«ãƒ¼ãƒ‰', icon: 'ğŸƒ', desc: 'åå…¥ +25%', max: 4, effect: 'gold_stack', chance: 0.02 },
            { id: 'infinite_wallet', rarity: 'L', name: 'ç„¡å°½è”µã®è²¡å¸ƒ', icon: 'ğŸ‘›', desc: 'ã‚´ãƒ¼ãƒ«ãƒ‰ç²å¾— +100%', max: 1, effect: 'gold_stack_heavy', chance: 0.005 },

            // --- ã‚«ãƒ†ã‚´ãƒª3: å‘¨å›ãƒ»ç‰¹æ®Šã‚·ã‚¹ãƒ†ãƒ  (15ç¨®) ---
            { id: 'memory_frag', rarity: 'R', name: 'è¨˜æ†¶ã®æ–­ç‰‡', icon: 'ğŸ§©', desc: 'å¸°é‚„æ™‚ã‚ªãƒ¼ãƒ– +5% / å€‹', max: 40, effect: 'orb_stack', chance: 0.15 },
            { id: 'time_spring', rarity: 'SR', name: 'æ™‚ç©ºã®ã­ã˜ã¾ã', icon: 'â³', desc: 'å…¨ä½“é€Ÿåº¦ +2% / å€‹', max: 25, effect: 'full_speed', chance: 0.05 },
            { id: 'rebirth_ash', rarity: 'HR', name: 'è»¢ç”Ÿã®ç°', icon: 'âš±ï¸', desc: 'å¸°é‚„åˆæœŸãƒ¬ãƒ™ãƒ« +2 / å€‹', max: 50, effect: 'init_lv_stack', chance: 0.08 },
            { id: 'warp_engine', rarity: 'SR', name: 'ãƒ¯ãƒ¼ãƒ—ã‚¨ãƒ³ã‚¸ãƒ³', icon: 'ğŸš€', desc: 'ãƒœã‚¹ã‚¹ã‚­ãƒƒãƒ—ç‡ +1% / å€‹', max: 10, effect: 'skip_boss', chance: 0.03 },
            { id: 'broken_clock', rarity: 'N', name: 'å£Šã‚ŒãŸæ™‚è¨ˆ', icon: 'ğŸ•’', desc: 'å…¨ä½“é€Ÿåº¦ +0.5% / å€‹', max: 100, effect: 'speed_lite', chance: 0.20 },
            { id: 'orb_magnet', rarity: 'HR', name: 'ã‚ªãƒ¼ãƒ–ç£çŸ³', icon: 'ğŸ§²', desc: 'ã‚ªãƒ¼ãƒ–ç²å¾— +2% / å€‹', max: 50, effect: 'orb_stack', chance: 0.07 },
            { id: 'karma_beads', rarity: 'SR', name: 'æ¥­ã®æ•°ç ', icon: 'ğŸ“¿', desc: 'ã‚ªãƒ¼ãƒ–å€ç‡ +10% / å€‹', max: 15, effect: 'orb_stack', chance: 0.04 },
            { id: 'phoenix_feather', rarity: 'L', name: 'ä¸æ­»é³¥ã®ç¾½', icon: 'ğŸª¶', desc: 'å…¨æ»…æ™‚ã‚¹ãƒ†ãƒ¼ã‚¸ä¿æŒ 10% / å€‹', max: 5, effect: 'keep_stage', chance: 0.01 },
            { id: 'exp_gear', rarity: 'N', name: 'çµŒé¨“ã®æ­¯è»Š', icon: 'âš™ï¸', desc: 'å…¨ä½“é€Ÿåº¦ +1% / å€‹', max: 50, effect: 'speed_lite', chance: 0.15 },
            { id: 'prophecy_page', rarity: 'HR', name: 'é è¨€è€…ã®é ', icon: 'ğŸ“„', desc: 'ãƒ¬ã‚¢æ•µå‡ºç¾ +5% / å€‹', max: 20, effect: 'rare_spawn', chance: 0.06 },
            { id: 'dimension_key', rarity: 'SR', name: 'æ¬¡å…ƒã®éµ', icon: 'ğŸ”‘', desc: 'å¸°é‚„æ™‚ã‚ªãƒ¼ãƒ– +20%', max: 5, effect: 'orb_stack_heavy', chance: 0.02 },
            { id: 'soul_anchor', rarity: 'R', name: 'é­‚ã®éŒ¨', icon: 'âš“', desc: 'å¸°é‚„æ™‚ã‚´ãƒ¼ãƒ«ãƒ‰ 1% ä¿æŒ', max: 10, effect: 'keep_gold', chance: 0.08 },
            { id: 'accelerator', rarity: 'HR', name: 'åŠ é€Ÿè£…ç½®', icon: 'ğŸ›ï¸', desc: 'å€é€ŸåŠ¹æœ +5% / å€‹', max: 20, effect: 'speed_stack', chance: 0.05 },
            { id: 'paradox_box', rarity: 'SR', name: 'ãƒ‘ãƒ©ãƒ‰ãƒƒã‚¯ã‚¹ç®±', icon: 'ğŸ“¦', desc: 'å…¨ã‚¬ãƒãƒ£æ’å‡ºç‡ +5%', max: 10, effect: 'none', chance: 0.03 },
            { id: 'rainbow_crystal', rarity: 'L', name: 'è™¹ã®ã‚¯ãƒªã‚¹ã‚¿ãƒ«', icon: 'ğŸŒˆ', desc: 'å…¨èƒ½åŠ›å¤§å¹…UP', max: 1, effect: 'all_stats_mega', chance: 0.01 }
        ];

        const ENEMY_ICONS = ['ğŸ‘¹', 'ğŸ’€', 'ğŸ‘»', 'ğŸ§Ÿ', 'ğŸº', 'ğŸ¦‚', 'ğŸ•·ï¸'];

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        // æ•°å€¤ã‚’K, M, Bãªã©ã®å˜ä½ä»˜ãå½¢å¼ã«å¤‰æ›ã™ã‚‹
        function formatNumber(num) {
            if (num < 1000) return Math.floor(num).toString();
            const suffixes = ["", "K", "M", "B", "T", "P", "E", "Z"];
            const i = Math.floor(Math.log10(num) / 3);
            const val = num / Math.pow(10, i * 3);
            return (val < 10 ? val.toFixed(2) : val.toFixed(1)) + suffixes[i];
        }

        // --- ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ ---
        // ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆï¼ˆæ’ä¹…å¼·åŒ–ï¼‰ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹
        class ArtifactManager {
            constructor() { this.owned = {}; }
            draw(count) {
                const results = [];
                for (let i = 0; i < count; i++) {
                    const r = Math.random();
                    let cumulative = 0;
                    let selectedRarity = 'N';
                    for (const [key, meta] of Object.entries(RARITIES)) {
                        cumulative += meta.chance;
                        if (r <= cumulative) { selectedRarity = key; break; }
                    }

                    // Box Gacha Logic: Filter out items that are at a reasonable 'max' (e.g. 1000 for N, 500 for R, etc.)
                    // Here we'll treat 1000 as a soft cap for the gacha listing.
                    const pool = ARTIFACT_DATA.filter(a => a.rarity === selectedRarity && (this.owned[a.id] || 0) < 1000);
                    if (pool.length === 0) {
                        // If pool empty, try a lower rarity or just skip
                        continue;
                    }
                    const picked = pool[Math.floor(Math.random() * pool.length)];
                    this.owned[picked.id] = (this.owned[picked.id] || 0) + 1;
                    results.push(picked);
                }
                return results;
            }
            getBonuses(stage) {
                let stats = {
                    atkAdd: 0, atkMulti: 1.0, goldMulti: 1.0, hpMulti: 1.0, instantKill: 0,
                    regen: 0, reflect: 0, critRate: 0, bossCoin: 1.0, evade: 0, doubleTap: 0
                };
                for (const [id, lv] of Object.entries(this.owned)) {
                    const data = ARTIFACT_DATA.find(a => a.id === id);
                    if (!data) continue;
                    let val = data.value * lv;

                    // Special Logic for Legend Items
                    if (data.special === 'divine_shred') val *= (1 + (stage * 0.02));
                    if (data.special === 'instant_kill') stats.instantKill += 0.05 * lv;
                    if (data.special === 'holy_regen') stats.regen += 0.01 * lv; // 1% HP per sec
                    if (data.special === 'curse_atk') stats.hpMulti *= Math.pow(0.9, lv); // -10% HP per lv
                    if (data.special === 'crit_up') stats.critRate += 0.10 * lv;
                    if (data.special === 'reflect_dmg') stats.reflect += 0.10 * lv;
                    if (data.special === 'boss_rich') stats.bossCoin += 1.0 * lv;
                    if (data.special === 'evasion_up') stats.evade += 0.10 * lv;
                    if (data.special === 'double_tap') stats.doubleTap += 0.15 * lv;

                    if (data.effect === 'atk_add') stats.atkAdd += val;
                    else if (data.effect === 'atk_multi') stats.atkMulti += val;
                    else if (data.effect === 'gold_multi') stats.goldMulti += val;
                    else if (data.effect === 'hp_multi') stats.hpMulti += val;
                }
                return stats;
            }
        }

        class GachaManager {
            constructor() { this.owned = {}; }

            // ãƒœãƒƒã‚¯ã‚¹ã‚¬ãƒãƒ£ä»•æ§˜ã®å®Œå…¨åŒ–ï¼šæŠ½é¸ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å®Œå‡¸æ¸ˆã¿ã‚’é™¤å¤–
            pull() {
                try {
                    const validItems = GACHA_ITEMS.filter(item => {
                        const count = this.owned[item.id] || 0;
                        return count < item.max;
                    });

                    if (validItems.length === 0) return null;

                    const totalChance = validItems.reduce((acc, item) => acc + item.chance, 0);
                    const r = Math.random() * totalChance;
                    let cumulative = 0;

                    for (const item of validItems) {
                        cumulative += item.chance;
                        if (r <= cumulative) {
                            this.owned[item.id] = (this.owned[item.id] || 0) + 1;
                            return item;
                        }
                    }
                    return validItems[validItems.length - 1];
                } catch (e) {
                    console.error("Gacha pull error:", e);
                    return null;
                }
            }
            getBonuses() {
                try {
                    let b = {
                        goldStack: 0, tripleGold: 0, doubleReward: 0, costCut: 1.0,
                        extraAttack: 0, initialLv: 0, hpStack: 1.0, bossAtk: 1.0,
                        atkStack: 1.0, critStack: 0, regenStack: 0, reflectStack: 0,
                        evadeStack: 0, doubleStack: 0, orbStack: 1.0, speedStack: 1.0
                    };

                    for (const [id, count] of Object.entries(this.owned)) {
                        const data = GACHA_ITEMS.find(i => i.id === id);
                        if (!data) continue;

                        // ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°åˆ¶ã‚¢ã‚¤ãƒ†ãƒ ã®è¨ˆç®—
                        if (data.effect === 'hp_stack') b.hpStack += count * 0.05;
                        if (data.effect === 'hp_stack_heavy') b.hpStack += count * 0.15;
                        if (data.effect === 'hp_stack_lite') b.hpStack += count * 0.02;
                        if (data.effect === 'boss_slayer') b.bossAtk += count * 0.10;
                        if (data.effect === 'atk_stack') b.atkStack += count * 0.04; // å¹³å‡åŒ–
                        if (data.effect === 'atk_stack_lite') b.atkStack += count * 0.01;
                        if (data.effect === 'crit_stack') b.critStack += count * 0.01;
                        if (data.effect === 'regen_stack') b.regenStack += count * 0.005;
                        if (data.effect === 'reflect_stack') b.reflectStack += count * 0.05;
                        if (data.effect === 'evade_stack') b.evadeStack += count * 0.01;
                        if (data.effect === 'double_stack') b.doubleStack += count * 0.02;
                        if (data.effect === 'gold_stack') b.goldStack += count * 0.05;
                        if (data.effect === 'gold_stack_lite') b.goldStack += count * 0.01;
                        if (data.effect === 'gold_stack_tiny') b.goldStack += count * 0.005;
                        if (data.effect === 'cost_stack') b.costCut *= Math.pow(0.98, count);
                        if (data.effect === 'orb_stack') b.orbStack += count * 0.05;
                        if (data.effect === 'orb_stack_heavy') b.orbStack += count * 0.20;
                        if (data.effect === 'speed_lite') b.speedStack += count * 0.005;
                    }
                    return b;
                } catch (e) {
                    console.error("Gacha bonus calculation error:", e);
                    return { goldStack: 0, costCut: 1.0, hpStack: 1.0, atkStack: 1.0 };
                }
            }
        }

        class Game {
            constructor() {
                this.stage = 1; this.gold = 0; this.orbs = 0; this.units = {};
                UNIT_TYPES.forEach(t => this.units[t.id] = 0);
                this.artMgr = new ArtifactManager();
                this.gachaMgr = new GachaManager();
                this.buyMode = 1;
                this.totalKills = 0;
                this.killsInSession = 0; // å€é€Ÿè§£æ”¾ç”¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨ä¼æ•°
                this.gameSpeed = 1.0;    // ç¾åœ¨ã®å€é€Ÿè¨­å®š
                this.missions = [
                    { id: 'kill_100', text: 'æ•µã‚’100ä½“è¨ä¼', target: 100, reward: 50, done: false },
                    { id: 'kill_500', text: 'æ•µã‚’500ä½“è¨ä¼', target: 500, reward: 200, done: false },
                    { id: 'kill_2000', text: 'æ•µã‚’2000ä½“è¨ä¼', target: 2000, reward: 1000, done: false }
                ];
            }
            getUnitCost(id, count = 1) {
                const type = UNIT_TYPES.find(u => u.id === id);
                let lv = this.units[id];
                let total = 0;
                const costCut = this.gachaMgr.getBonuses().costCut;
                for (let i = 0; i < count; i++) {
                    total += type.baseCost * Math.pow(1.15, lv + i);
                }
                return Math.floor(total * costCut);
            }
            getMaxBuy(id) {
                const type = UNIT_TYPES.find(u => u.id === id);
                const costCut = this.gachaMgr.getBonuses().costCut;
                let count = 0; let tempGold = this.gold; let lv = this.units[id];
                while (true) {
                    let cost = Math.floor(type.baseCost * Math.pow(1.15, lv + count) * costCut);
                    if (tempGold >= cost && count < 1000) { tempGold -= cost; count++; } else break;
                }
                return count;
            }
            getStats() {
                try {
                    let baseAtk = 0;
                    UNIT_TYPES.forEach(t => {
                        const lv = this.units[t.id] || 0;
                        baseAtk += (t.baseAtk * 1.5) * lv;
                    });
                    if (baseAtk === 0 || isNaN(baseAtk)) baseAtk = 10;

                    const a = this.artMgr.getBonuses(this.stage);
                    const g = this.gachaMgr.getBonuses();
                    const orbBonus = (1 + (this.orbs * 0.1)) * g.orbStack;

                    let dps = (baseAtk * (2.0 + a.atkAdd) * a.atkMulti * g.atkStack) * orbBonus;
                    if (battle.isBoss) dps *= g.bossAtk;
                    if (isNaN(dps)) dps = 10;

                    return {
                        dps,
                        extraAttack: g.extraAttack + a.doubleTap + g.doubleStack,
                        goldMulti: a.goldMulti * (1 + g.goldStack),
                        hpMulti: a.hpMulti * g.hpStack,
                        instantKill: a.instantKill,
                        tripleGold: g.tripleGold,
                        doubleReward: g.doubleReward,
                        regen: a.regen + g.regenStack,
                        reflect: a.reflect + g.reflectStack,
                        critRate: a.critRate + g.critStack,
                        evade: a.evade + g.evadeStack,
                        bossCoin: a.bossCoin
                    };
                } catch (e) {
                    console.error("Stats calculation error:", e);
                    return { dps: 10, goldMulti: 1, hpMulti: 1 };
                }
            }
            checkMissions() {
                this.missions.forEach(m => {
                    if (!m.done && this.totalKills >= m.target) {
                        m.done = true;
                        this.orbs += m.reward;
                        alert(`å®Ÿç¸¾é”æˆ: ${m.text}\nå ±é…¬: ${m.reward} Orbs ç²å¾—ï¼`);
                    }
                });
            }
            save() {
                const data = {
                    s: this.stage, g: this.gold, o: this.orbs, u: this.units,
                    a: this.artMgr.owned, ga: this.gachaMgr.owned, tk: this.totalKills, md: this.missions.map(m => m.done)
                };
                localStorage.setItem('RPG_SAVE_PRO_V2', JSON.stringify(data));
            }
            load() {
                try {
                    const raw = localStorage.getItem('RPG_SAVE_PRO_V2');
                    if (raw) {
                        const d = JSON.parse(raw);
                        this.stage = d.s || 1;
                        this.gold = d.g || 0;
                        this.orbs = d.o || 0;
                        this.totalKills = d.tk || 0;

                        // ãƒ¦ãƒ‹ãƒƒãƒˆãƒ¬ãƒ™ãƒ«ã®çµ±åˆï¼ˆæ–°ãƒ¦ãƒ‹ãƒƒãƒˆå¯¾å¿œï¼‰
                        if (d.u) {
                            Object.keys(d.u).forEach(id => {
                                if (this.units.hasOwnProperty(id)) this.units[id] = d.u[id];
                            });
                        }

                        // ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ï¼ˆå­˜åœ¨ã—ãªã„ã‚‚ã®ã¯é™¤å¤–ï¼‰
                        if (d.a) {
                            Object.keys(d.a).forEach(id => {
                                if (ARTIFACT_DATA.find(i => i.id === id)) this.artMgr.owned[id] = d.a[id];
                            });
                        }

                        // ã‚¬ãƒãƒ£ã‚¢ã‚¤ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ï¼ˆå­˜åœ¨ã—ãªã„ã‚‚ã®ã¯é™¤å¤–ï¼‰
                        if (d.ga) {
                            Object.keys(d.ga).forEach(id => {
                                if (GACHA_ITEMS.find(i => i.id === id)) this.gachaMgr.owned[id] = d.ga[id];
                            });
                        }

                        if (d.md) this.missions.forEach((m, i) => m.done = d.md[i]);
                    }
                } catch (e) {
                    console.error("Save load error:", e);
                }
            }
        }

        const game = new Game();
        let battle = { enemyHp: 50, enemyMaxHp: 50, allyHp: 200, allyMaxHp: 200, lastTick: Date.now(), isBoss: false };

        // --- UI ---
        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`${t}-tab`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function toggleBuyMode() {
            if (game.buyMode === 1) game.buyMode = 10;
            else if (game.buyMode === 10) game.buyMode = -1;
            else game.buyMode = 1;
            document.getElementById('buy-mode-btn').textContent = `è³¼å…¥: ${game.buyMode === -1 ? 'MAX' : 'x' + game.buyMode}`;
            updateUI();
        }

        function setSpeed(val) {
            game.gameSpeed = val;
            document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
            if (val === 1) document.querySelector('.speed-controls button:nth-child(1)').classList.add('active');
            if (val === 2) document.getElementById('speed-x2').classList.add('active');
            if (val === 3) document.getElementById('speed-x3').classList.add('active');
        }

        function initUI() {
            const list = document.getElementById('unit-list');
            list.innerHTML = '';
            UNIT_TYPES.forEach(type => {
                const card = document.createElement('div');
                card.id = `unit-card-${type.id}`;
                card.className = 'item-card';
                card.style.display = game.stage >= type.unlockAt ? 'flex' : 'none';
                card.innerHTML = `
                    <div class="item-icon-wrapper">
                        <div class="item-icon">${type.icon}</div>
                        <div class="unit-label">${type.name}</div>
                    </div>
                    <div class="item-info">
                        <span class="item-name">${type.name} (Lv <span id="lv-${type.id}">0</span>)</span>
                        <span class="item-desc">Atk: ${formatNumber(type.baseAtk)} / Cost: <span id="cost-${type.id}">0</span></span>
                    </div>
                    <button class="buy-btn" id="btn-${type.id}" onclick="buyUnit('${type.id}')">é›‡ç”¨</button>
                `;
                list.appendChild(card);
            });

            // Initial Mission List
            const mList = document.getElementById('mission-list');
            mList.innerHTML = '';
            game.missions.forEach(m => {
                const el = document.createElement('div');
                el.id = `mission-${m.id}`;
                el.className = 'mission-item';
                mList.appendChild(el);
            });

            filterArtifacts(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ç¶­æŒã—ã¦å®ç‰©ãƒªã‚¹ãƒˆç”Ÿæˆ
            updateGachaOwned();
        }

        // ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢ãƒ»è¡¨ç¤º
        function filterArtifacts() {
            const rarity = document.getElementById('rarity-filter').value;
            const artGrid = document.getElementById('artifact-list');
            artGrid.innerHTML = '';

            ARTIFACT_DATA.forEach(art => {
                if (rarity !== 'ALL' && art.rarity !== rarity) return;

                const slot = document.createElement('div');
                slot.id = `art-slot-${art.id}`;
                slot.className = 'artifact-slot';
                if (game.artMgr.owned[art.id] > 0) slot.classList.add('owned');
                slot.style.borderColor = RARITIES[art.rarity].color;
                slot.innerHTML = art.icon;

                // ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã®ç‰¹åˆ¥æ¼”å‡º
                if (art.rarity === 'L') {
                    slot.onclick = () => showLegendDetail(art);
                }

                slot.onmouseenter = (e) => showTooltip(e, art);
                slot.onmouseleave = hideTooltip;
                artGrid.appendChild(slot);
            });
        }

        function showLegendDetail(art) {
            const lv = game.artMgr.owned[art.id] || 0;
            const popup = document.getElementById('legend-detail');
            const content = document.getElementById('legend-detail-content');
            content.innerHTML = `
                <div style="font-size:3rem; margin-bottom:10px;">${art.icon}</div>
                <div style="color:var(--gold); font-weight:bold; letter-spacing:2px;">LEGENDARY ARTIFACT</div>
                <div style="font-size:1.5rem; font-weight:bold; margin:10px 0;">${art.name}</div>
                <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; font-size:0.85rem; text-align:left; color:var(--text-dim);">
                    <b>å›ºæœ‰ã‚¹ã‚­ãƒ«: ${art.special || 'ãªã—'}</b><br>
                    åŠ¹æœ: ${art.effect.replace('_', ' ')} (+${(art.value * 100).toFixed(1)}%/Lv)<br><br>
                    <span style="color:var(--text-main)">ç¾åœ¨ãƒ¬ãƒ™ãƒ«: ${lv}</span><br>
                    <span style="color:var(--accent-secondary)">ã“ã®ç§˜å®ã¯æŒã¡ç¶šã‘ã‚‹ã ã‘ã§ã‚ãªãŸã®é­‚ã‚’æ°¸ç¶šçš„ã«å¼·åŒ–ã—ã¾ã™ã€‚</span>
                </div>
            `;
            popup.style.display = 'block';
        }

        function showTooltip(e, art) {
            const lv = game.artMgr.owned[art.id] || 0;
            const r = RARITIES[art.rarity];
            const tt = document.getElementById('custom-tooltip');
            tt.innerHTML = `
                <div style="color:${r.color}; font-size:0.7rem; font-weight:bold;">${r.name}</div>
                <div style="font-weight:bold; font-size:1rem; margin:4px 0;">${art.name}</div>
                <div style="color:var(--accent-secondary);">Level: ${lv.toLocaleString()}</div>
                <div style="font-size:0.75rem; color:var(--text-dim); margin-top:8px;">
                    åŠ¹æœ: ${art.effect.replace('_', ' ')} (+${(art.value * 100).toFixed(1)}%/Lv)
                    ${art.special ? `<br><span style="color:var(--gold)">â˜…ç‰¹æ®Š: ${art.special}</span>` : ''}
                </div>
            `;
            tt.style.display = 'block';
            moveTooltip(e);
        }

        function moveTooltip(e) {
            const tt = document.getElementById('custom-tooltip');
            tt.style.left = (e.clientX + 15) + 'px';
            tt.style.top = (e.clientY + 15) + 'px';
        }

        function hideTooltip() { document.getElementById('custom-tooltip').style.display = 'none'; }

        function updateGachaOwned() {
            const list = document.getElementById('gacha-owned-list');
            list.innerHTML = '';
            for (const [id, count] of Object.entries(game.gachaMgr.owned)) {
                if (count <= 0) continue;
                const data = GACHA_ITEMS.find(i => i.id === id);
                if (!data) continue; // æ—§ãƒ‡ãƒ¼ã‚¿ï¼ˆå‰Šé™¤ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—

                const el = document.createElement('div');
                el.className = 'gacha-item';
                el.innerHTML = `
                    <div style="font-size:1.5rem;">${data.icon}</div>
                    <div style="display:flex; flex-direction:column; text-align:left;">
                        <div style="font-weight:bold;">${data.name} x${count}</div>
                        <div style="font-size:0.7rem; color:var(--text-dim);">${data.desc}</div>
                    </div>
                `;
                list.appendChild(el);
            }
        }

        function updateUI() {
            const s = game.getStats();
            const screen = document.getElementById('battle-screen');

            // èƒŒæ™¯ã®å‹•çš„åˆ‡ã‚Šæ›¿ãˆ
            screen.className = 'battle-screen'; // Reset
            if (battle.isBoss) {
                screen.classList.add('bg-boss');
            } else {
                const bgClass = game.stage < 10 ? 'bg-plains' : (game.stage < 20 ? 'bg-ruins' : 'bg-plains');
                screen.classList.add(bgClass);
            }

            // å€é€Ÿãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆ50ä½“è¨ä¼ã§è§£æ”¾ï¼‰
            const speedControls = document.getElementById('speed-controls');
            if (game.killsInSession >= 50) speedControls.style.display = 'flex';
            else speedControls.style.display = 'none';

            document.getElementById('stage-num').innerHTML = battle.isBoss ? `<span style="color:var(--danger)">BOSS</span> ${game.stage}` : game.stage;
            document.getElementById('gold-val').textContent = formatNumber(game.gold);
            document.getElementById('orb-val').textContent = game.orbs.toLocaleString();
            document.getElementById('dps-val').textContent = formatNumber(s.dps);

            const baseAtkSum = UNIT_TYPES.reduce((acc, t) => acc + t.baseAtk * game.units[t.id], 0) || 5;
            document.getElementById('multi-val').textContent = `x${(s.dps / baseAtkSum).toFixed(1)}`;

            UNIT_TYPES.forEach(type => {
                const card = document.getElementById(`unit-card-${type.id}`);
                if (game.stage >= type.unlockAt) card.style.display = 'flex';
                let bCount = game.buyMode === -1 ? game.getMaxBuy(type.id) : game.buyMode;
                if (bCount < 1) bCount = 1;
                const cost = game.getUnitCost(type.id, bCount);
                document.getElementById(`lv-${type.id}`).textContent = game.units[type.id].toLocaleString();
                document.getElementById(`cost-${type.id}`).textContent = formatNumber(cost);
                const btn = document.getElementById(`btn-${type.id}`);
                btn.disabled = game.gold < cost;
            });

            // Missions
            game.missions.forEach(m => {
                const el = document.getElementById(`mission-${m.id}`);
                if (el) {
                    el.innerHTML = `<span>${m.text} (${Math.min(game.totalKills, m.target)}/${m.target})</span>
                                   <span style="color:${m.done ? 'var(--success)' : 'var(--text-dim)'}">${m.done ? 'é”æˆ' : m.reward + 'O'}</span>`;
                }
            });

            const pending = Math.floor(game.stage / 10);
            document.getElementById('pending-orbs').textContent = pending;
            document.getElementById('return-btn').disabled = game.stage < 10;
            document.getElementById('enemy-hp-bar').style.width = (battle.enemyHp / battle.enemyMaxHp * 100) + '%';
            document.getElementById('ally-hp-bar').style.width = (battle.allyHp / battle.allyMaxHp * 100) + '%';
        }

        // --- ROI ãƒ­ã‚¸ãƒƒã‚¯ ---
        // ROIæ¼”å‡º: ãƒœã‚¿ãƒ³ä½ç½®ã«ã€Œæ”»æ’ƒåŠ›UP!ã€ã‚’è¡¨ç¤º
        function createAtkUpPop(targetEl) {
            const btn = targetEl;
            if (!btn) return;
            const rect = btn.getBoundingClientRect();
            const pop = document.createElement('div');
            pop.className = 'atk-up-pop';
            pop.textContent = 'æ”»æ’ƒåŠ›UP!';
            pop.style.left = (rect.left + rect.width / 2) + 'px';
            pop.style.top = (rect.top + window.scrollY) + 'px';
            document.body.appendChild(pop);
            setTimeout(() => pop.remove(), 600);
        }

        function buyUnit(id) {
            let bCount = game.buyMode === -1 ? game.getMaxBuy(id) : game.buyMode;
            if (bCount < 1) return;
            const cost = game.getUnitCost(id, bCount);
            if (game.gold >= cost) {
                game.gold -= cost; game.units[id] += bCount;
                if (typeof event !== 'undefined' && event.currentTarget) {
                    createAtkUpPop(event.currentTarget);
                }
                updateUI(); game.save();
            }
        }

        function pullGacha() {
            if (game.orbs >= 100) {
                game.orbs -= 100;
                const res = game.gachaMgr.pull();
                if (res) alert(`ç²å¾—: ${res.icon} ${res.name}\n${res.desc}`);
                else alert(`æ®‹å¿µï¼ä½•ã‚‚ç²å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã¾ãŸã¯æ‰€æŒä¸Šé™ï¼‰ã€‚`);
                updateGachaOwned(); updateUI(); game.save();
            } else alert(`ã‚ªãƒ¼ãƒ–ãŒè¶³ã‚Šã¾ã›ã‚“ï¼`);
        }

        function createPop(val, isGold = false, isCrit = false) {
            const screen = document.getElementById('battle-screen');
            const el = document.createElement('div');
            el.className = 'damage-popup';

            if (typeof val === 'string') {
                el.textContent = val;
            } else {
                el.textContent = isGold ? `+${formatNumber(val)}G` : `-${formatNumber(val)}`;
            }

            if (isCrit) {
                el.style.color = '#ffeb3b';
                el.style.fontSize = '1.8rem';
                el.style.zIndex = '150';
            } else {
                el.style.color = isGold ? 'var(--gold)' : 'var(--danger)';
            }

            el.style.left = `calc(50% + ${(Math.random() * 80 - 40)}px)`;
            el.style.top = `45%`;
            screen.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function spawnEnemy() {
            try {
                game.stage++;
                const isBoss = (game.stage % 10 === 0);
                battle.isBoss = isBoss;

                // 150éšä»¥é™ã®ç·©å’Œç­–ï¼šHPã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¿‚æ•°ã‚’ã•ã‚‰ã«å¾®æ¸›
                let baseScaling = game.stage < 150 ? 1.25 : 1.08;
                let hp = 50 * Math.pow(baseScaling, game.stage - 1);
                if (game.stage >= 150) {
                    hp = 50 * Math.pow(1.25, 149) * Math.pow(1.08, game.stage - 150);
                }

                if (isBoss) {
                    hp *= 10;
                    // ãƒœã‚¹çªå…¥æ¼”å‡º
                    const banner = document.getElementById('boss-banner');
                    banner.classList.add('show');
                    document.getElementById('battle-screen').classList.add('edge-flash-red');
                    setTimeout(() => {
                        banner.classList.remove('show');
                        document.getElementById('battle-screen').classList.remove('edge-flash-red');
                    }, 2000);
                }

                const isRare = !isBoss && Math.random() < 0.05;
                if (isRare) hp *= 0.5;

                battle.enemyMaxHp = Math.max(10, Math.floor(hp));
                battle.enemyHp = battle.enemyMaxHp;
                battle.isRare = isRare;

                document.getElementById('enemy-avatar').textContent = isRare ? 'ğŸ’°' : (isBoss ? 'ğŸ‰' : ENEMY_ICONS[Math.floor(Math.random() * ENEMY_ICONS.length)]);
                document.getElementById('enemy-avatar').style.filter = isRare ? 'drop-shadow(0 0 10px gold)' : '';
            } catch (e) {
                console.error("Enemy spawn error:", e);
            }
        }

        function handleReturn() {
            if (!confirm("æœ¬å½“ã«å¸°é‚„ã—ã¾ã™ã‹ï¼Ÿ ç¾åœ¨ã®ã‚´ãƒ¼ãƒ«ãƒ‰ã¨ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œåº¦ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚")) return;

            try {
                const orbs = Math.floor(game.stage / 10);
                game.orbs += orbs;
                game.stage = 1;
                game.gold = 0;
                game.killsInSession = 0; // å€é€Ÿæ¡ä»¶ãƒªã‚»ãƒƒãƒˆ

                const g = game.gachaMgr.getBonuses();
                UNIT_TYPES.forEach(t => game.units[t.id] = g.initialLv);
                battle.enemyHp = 50; battle.enemyMaxHp = 50; battle.isBoss = false;

                // ç”»é¢é·ç§»æ¼”å‡ºã¯Step 2ã¸
                initUI(); updateUI(); game.save();
            } catch (e) {
                console.error("Return error:", e);
            }
        }

        function openHelp() { document.getElementById('help-modal').style.display = 'flex'; }
        function closeHelp() { document.getElementById('help-modal').style.display = 'none'; }

        function closeResult() {
            document.getElementById('result-overlay').style.display = 'none';
            initUI(); updateUI(); game.save();
        }

        function loop() {
            try {
                const now = Date.now();
                const dt = ((now - battle.lastTick) / 1000) * game.gameSpeed; // å€é€Ÿé©ç”¨ã®ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ 
                battle.lastTick = now;

                const s = game.getStats();
                battle.allyMaxHp = 200 * s.hpMulti;

                // HPå†ç”Ÿï¼ˆãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰åŠ¹æœãªã©ï¼‰
                if (battle.allyHp < battle.allyMaxHp) {
                    battle.allyHp += (battle.allyMaxHp * s.regen) * dt;
                }

                // å³æ­»ï¼ˆä½ç¢ºç‡ã§æ•µã‚’è‘¬ã‚‹ï¼‰
                if (!battle.isBoss && Math.random() < (s.instantKill * dt)) {
                    battle.enemyHp = 0;
                    document.getElementById('enemy-entity').classList.add('death-flash');
                    setTimeout(() => document.getElementById('enemy-entity').classList.remove('death-flash'), 400);
                }

                let dps = s.dps;
                if (Math.random() < s.extraAttack) dps *= 2;

                let isCrit = false;
                if (Math.random() < s.critRate) {
                    dps *= 3;
                    isCrit = true;
                }

                battle.enemyHp -= dps * dt;

                // ãƒ’ãƒƒãƒˆæ¼”å‡ºï¼šå€é€Ÿæ™‚ã‚‚è² è·ã‚’ä¸‹ã’ã¤ã¤è¡¨ç¤º
                if (now % Math.floor(600 / game.gameSpeed) < 35) {
                    const popVal = isCrit ? `CRITICAL! ${formatNumber(dps / 2)}` : formatNumber(dps / 2);
                    createPop(popVal, false, isCrit);
                    document.getElementById('enemy-entity').classList.add('hit-flash');
                    setTimeout(() => document.getElementById('enemy-entity').classList.remove('hit-flash'), 100);
                }

                // æ•µè¨ä¼æ™‚ã®å‡¦ç†
                if (battle.enemyHp <= 0) {
                    game.totalKills++;
                    game.killsInSession++; // ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨ä¼æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                    game.checkMissions();

                    let g = 10 * Math.pow(1.2, game.stage - 1) * s.goldMulti;
                    if (battle.isBoss) g *= (5 * s.bossCoin);
                    if (battle.isRare) g *= 20;
                    if (Math.random() < s.tripleGold) g *= 3;
                    if (Math.random() < s.doubleReward) g *= 2;
                    game.gold += g;
                    createPop(g, true);
                    spawnEnemy();
                }

                // è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸
                let dmg = (2 + game.stage * 1.5) * dt;
                if (Math.random() >= s.evade) {
                    battle.allyHp -= dmg;
                    if (s.reflect > 0) battle.enemyHp -= (dmg * s.reflect * 10);
                }

                // å…¨æ»…æ™‚ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ€ã‚¦ãƒ³ï¼‰
                if (battle.allyHp <= 0) {
                    const screen = document.getElementById('battle-screen');
                    const crack = document.getElementById('stage-down-crack');

                    // æ¼”å‡ºï¼šç”»é¢ãŒæ³¢æ‰“ã¡ã€ãƒ’ãƒ“ãŒå…¥ã‚‹
                    screen.classList.add('shake-screen');
                    crack.style.display = 'block';
                    crack.style.opacity = '1';

                    setTimeout(() => {
                        screen.classList.remove('shake-screen');
                        crack.style.opacity = '0';
                        setTimeout(() => crack.style.display = 'none', 300);
                    }, 1000);

                    // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ€ã‚¦ãƒ³ã®ç¢ºå®Ÿãªåæ˜ ï¼š
                    // spawnEnemyã¯å®Ÿè¡Œæ™‚ã«stageã‚’+1ã™ã‚‹ãŸã‚ã€2ã¤æˆ»ã—ã¦ã‹ã‚‰å‘¼ã¶ã“ã¨ã§å®Ÿè³ª1ã¤æˆ»ã‚‹
                    game.stage = Math.max(0, game.stage - 2);
                    spawnEnemy(); // ã“ã“ã§æ–°ãŸãªæ•µï¼ˆé›‘é­šï¼‰ãŒç”Ÿæˆã•ã‚Œã€isBossã‚‚å†è¨ˆç®—ã•ã‚Œã‚‹

                    battle.allyHp = battle.allyMaxHp;
                }

                updateUI();
            } catch (e) {
                console.error("Critical Loop Error:", e);
            }
            requestAnimationFrame(loop);
        }

        game.load();
        initUI();
        updateUI();
        window.addEventListener('mousemove', moveTooltip);
        requestAnimationFrame(loop);
        setInterval(() => game.save(), 5000);
    </script>
</body>

</html>